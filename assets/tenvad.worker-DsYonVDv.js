let e=null,p=0,o=256,w=.5,g=0,P=0,b=0,n=0,f=null,d=0,E=0;self.onmessage=async a=>{const t=a.data;try{switch(t.type){case"INIT":await v(t.id,t.payload);break;case"PROCESS":T(t.payload.samples,t.payload.globalSampleOffset);break;case"RESET":A(t.id);break;case"DISPOSE":U(t.id);break}}catch(l){_({type:"ERROR",id:t.id??0,payload:String(l)})}};async function v(a,t){o=t.hopSize||256,w=t.threshold||.5;const l=t.wasmPath||"/wasm/";try{const i=new URL(l+"ten_vad.js",self.location.origin).href,y=await(await fetch(i)).text(),u=URL.createObjectURL(new Blob([y],{type:"application/javascript"})),{default:m}=await import(u);URL.revokeObjectURL(u),e=await m({locateFile:r=>r.endsWith(".wasm")?new URL(l+r,self.location.origin).href:r}),n=e._malloc(4),g=e._malloc(o*2),P=e._malloc(4),b=e._malloc(4);const s=e._ten_vad_create(n,o,w);if(s!==0)throw new Error(`ten_vad_create failed with code ${s}`);p=e.HEAP32[n>>2];const c=e._ten_vad_get_version(),h=e.UTF8ToString?e.UTF8ToString(c):`ptr@${c}`;f=new Float32Array(o),d=0,E=0,console.log(`[TenVAD Worker] Initialized: hopSize=${o}, threshold=${w}, version=${h}`),_({type:"INIT",id:a,payload:{success:!0,version:h}})}catch(i){console.error("[TenVAD Worker] Init failed:",i),_({type:"ERROR",id:a,payload:`TEN-VAD init failed: ${i}`})}}function T(a,t){if(!e||!p||!f)return;const l=performance.now();let i=t,R=!1;const y=Math.ceil((a.length+d)/o),u=new Float32Array(y),m=new Uint8Array(y);let s=0,c=0;for(;c<a.length;){for(;d<o&&c<a.length;)f[d++]=a[c++];if(d>=o){R||(i=t+c-o,R=!0);for(let r=0;r<o;r++){const S=Math.max(-1,Math.min(1,f[r]));e.HEAP16[(g>>1)+r]=Math.round(S*32767)}e._ten_vad_process(p,g,o,P,b)===0&&(u[s]=e.HEAPF32[P>>2],m[s]=e.HEAP32[b>>2],s++),d=0}}if(E=t+a.length,s>0){const h=u.slice(0,s),r=m.slice(0,s),S={probabilities:h,flags:r,globalSampleOffset:i,hopCount:s,processingTimeMs:performance.now()-l};self.postMessage({type:"RESULT",payload:S},[h.buffer,r.buffer])}}function A(a){f&&(f.fill(0),d=0),E=0,e&&p&&(e._ten_vad_destroy(n),e._ten_vad_create(n,o,w)===0&&(p=e.HEAP32[n>>2])),_({type:"RESET",id:a,payload:{success:!0}})}function U(a){e&&p&&(e._ten_vad_destroy(n),e._free(g),e._free(P),e._free(b),e._free(n)),e=null,p=0,f=null,_({type:"DISPOSE",id:a,payload:{success:!0}})}function _(a,t){try{t||self.postMessage(a)}catch(l){console.error("[TenVAD Worker] Failed to post message:",l)}}
