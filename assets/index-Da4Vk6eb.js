(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const o of s.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&n(o)}).observe(document,{childList:!0,subtree:!0});function r(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerPolicy&&(s.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?s.credentials="include":i.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(i){if(i.ep)return;i.ep=!0;const s=r(i);fetch(i.href,s)}})();const pn=!1,vn=(t,e)=>t===e,Er=Symbol("solid-proxy"),bn=typeof Proxy=="function",yn=Symbol("solid-track"),Qt={equals:vn};let Kr=tn;const ct=1,Yt=2,Xr={owned:null,cleanups:null,context:null,owner:null};var we=null;let mr=null,Sn=null,pe=null,$e=null,Je=null,tr=0;function Dt(t,e){const r=pe,n=we,i=t.length===0,s=e===void 0?n:e,o=i?Xr:{owned:null,cleanups:null,context:s?s.context:null,owner:s},l=i?t:()=>t(()=>lt(()=>Pt(o)));we=o,pe=null;try{return $t(l,!0)}finally{pe=r,we=n}}function $(t,e){e=e?Object.assign({},Qt,e):Qt;const r={value:t,observers:null,observerSlots:null,comparator:e.equals||void 0},n=i=>(typeof i=="function"&&(i=i(r.value)),en(r,i));return[Jr.bind(r),n]}function Q(t,e,r){const n=Ir(t,e,!1,ct);Bt(n)}function Ve(t,e,r){Kr=Cn;const n=Ir(t,e,!1,ct);n.user=!0,Je?Je.push(n):Bt(n)}function Re(t,e,r){r=r?Object.assign({},Qt,r):Qt;const n=Ir(t,e,!0,0);return n.observers=null,n.observerSlots=null,n.comparator=r.equals||void 0,Bt(n),Jr.bind(n)}function Lr(t){return $t(t,!1)}function lt(t){if(pe===null)return t();const e=pe;pe=null;try{return t()}finally{pe=e}}function Rr(t){Ve(()=>lt(t))}function bt(t){return we===null||(we.cleanups===null?we.cleanups=[t]:we.cleanups.push(t)),t}function Jr(){if(this.sources&&this.state)if(this.state===ct)Bt(this);else{const t=$e;$e=null,$t(()=>Kt(this),!1),$e=t}if(pe){const t=this.observers?this.observers.length:0;pe.sources?(pe.sources.push(this),pe.sourceSlots.push(t)):(pe.sources=[this],pe.sourceSlots=[t]),this.observers?(this.observers.push(pe),this.observerSlots.push(pe.sources.length-1)):(this.observers=[pe],this.observerSlots=[pe.sources.length-1])}return this.value}function en(t,e,r){let n=t.value;return(!t.comparator||!t.comparator(n,e))&&(t.value=e,t.observers&&t.observers.length&&$t(()=>{for(let i=0;i<t.observers.length;i+=1){const s=t.observers[i],o=mr&&mr.running;o&&mr.disposed.has(s),(o?!s.tState:!s.state)&&(s.pure?$e.push(s):Je.push(s),s.observers&&rn(s)),o||(s.state=ct)}if($e.length>1e6)throw $e=[],new Error},!1)),e}function Bt(t){if(!t.fn)return;Pt(t);const e=tr;xn(t,t.value,e)}function xn(t,e,r){let n;const i=we,s=pe;pe=we=t;try{n=t.fn(e)}catch(o){return t.pure&&(t.state=ct,t.owned&&t.owned.forEach(Pt),t.owned=null),t.updatedAt=r+1,nn(o)}finally{pe=s,we=i}(!t.updatedAt||t.updatedAt<=r)&&(t.updatedAt!=null&&"observers"in t?en(t,n):t.value=n,t.updatedAt=r)}function Ir(t,e,r,n=ct,i){const s={fn:t,state:n,updatedAt:null,owned:null,sources:null,sourceSlots:null,cleanups:null,value:e,owner:we,context:we?we.context:null,pure:r};return we===null||we!==Xr&&(we.owned?we.owned.push(s):we.owned=[s]),s}function Zt(t){if(t.state===0)return;if(t.state===Yt)return Kt(t);if(t.suspense&&lt(t.suspense.inFallback))return t.suspense.effects.push(t);const e=[t];for(;(t=t.owner)&&(!t.updatedAt||t.updatedAt<tr);)t.state&&e.push(t);for(let r=e.length-1;r>=0;r--)if(t=e[r],t.state===ct)Bt(t);else if(t.state===Yt){const n=$e;$e=null,$t(()=>Kt(t,e[0]),!1),$e=n}}function $t(t,e){if($e)return t();let r=!1;e||($e=[]),Je?r=!0:Je=[],tr++;try{const n=t();return wn(r),n}catch(n){r||(Je=null),$e=null,nn(n)}}function wn(t){if($e&&(tn($e),$e=null),t)return;const e=Je;Je=null,e.length&&$t(()=>Kr(e),!1)}function tn(t){for(let e=0;e<t.length;e++)Zt(t[e])}function Cn(t){let e,r=0;for(e=0;e<t.length;e++){const n=t[e];n.user?t[r++]=n:Zt(n)}for(e=0;e<r;e++)Zt(t[e])}function Kt(t,e){t.state=0;for(let r=0;r<t.sources.length;r+=1){const n=t.sources[r];if(n.sources){const i=n.state;i===ct?n!==e&&(!n.updatedAt||n.updatedAt<tr)&&Zt(n):i===Yt&&Kt(n,e)}}}function rn(t){for(let e=0;e<t.observers.length;e+=1){const r=t.observers[e];r.state||(r.state=Yt,r.pure?$e.push(r):Je.push(r),r.observers&&rn(r))}}function Pt(t){let e;if(t.sources)for(;t.sources.length;){const r=t.sources.pop(),n=t.sourceSlots.pop(),i=r.observers;if(i&&i.length){const s=i.pop(),o=r.observerSlots.pop();n<i.length&&(s.sourceSlots[o]=n,i[n]=s,r.observerSlots[n]=o)}}if(t.tOwned){for(e=t.tOwned.length-1;e>=0;e--)Pt(t.tOwned[e]);delete t.tOwned}if(t.owned){for(e=t.owned.length-1;e>=0;e--)Pt(t.owned[e]);t.owned=null}if(t.cleanups){for(e=t.cleanups.length-1;e>=0;e--)t.cleanups[e]();t.cleanups=null}t.state=0}function Tn(t){return t instanceof Error?t:new Error(typeof t=="string"?t:"Unknown error",{cause:t})}function nn(t,e=we){throw Tn(t)}const _n=Symbol("fallback");function Br(t){for(let e=0;e<t.length;e++)t[e]()}function $n(t,e,r={}){let n=[],i=[],s=[],o=0,l=e.length>1?[]:null;return bt(()=>Br(s)),()=>{let c=t()||[],u=c.length,f,d;return c[yn],lt(()=>{let x,T,w,S,M,k,p,R,A;if(u===0)o!==0&&(Br(s),s=[],n=[],i=[],o=0,l&&(l=[])),r.fallback&&(n=[_n],i[0]=Dt(H=>(s[0]=H,r.fallback())),o=1);else if(o===0){for(i=new Array(u),d=0;d<u;d++)n[d]=c[d],i[d]=Dt(v);o=u}else{for(w=new Array(u),S=new Array(u),l&&(M=new Array(u)),k=0,p=Math.min(o,u);k<p&&n[k]===c[k];k++);for(p=o-1,R=u-1;p>=k&&R>=k&&n[p]===c[R];p--,R--)w[R]=i[p],S[R]=s[p],l&&(M[R]=l[p]);for(x=new Map,T=new Array(R+1),d=R;d>=k;d--)A=c[d],f=x.get(A),T[d]=f===void 0?-1:f,x.set(A,d);for(f=k;f<=p;f++)A=n[f],d=x.get(A),d!==void 0&&d!==-1?(w[d]=i[f],S[d]=s[f],l&&(M[d]=l[f]),d=T[d],x.set(A,d)):s[f]();for(d=k;d<u;d++)d in w?(i[d]=w[d],s[d]=S[d],l&&(l[d]=M[d],l[d](d))):i[d]=Dt(v);i=i.slice(0,o=u),n=c.slice(0)}return i});function v(x){if(s[d]=x,l){const[T,w]=$(d);return l[d]=w,e(c[d],T)}return e(c[d])}}}function O(t,e){return lt(()=>t(e||{}))}function Ot(){return!0}const Mn={get(t,e,r){return e===Er?r:t.get(e)},has(t,e){return e===Er?!0:t.has(e)},set:Ot,deleteProperty:Ot,getOwnPropertyDescriptor(t,e){return{configurable:!0,enumerable:!0,get(){return t.get(e)},set:Ot,deleteProperty:Ot}},ownKeys(t){return t.keys()}};function pr(t){return(t=typeof t=="function"?t():t)?t:{}}function En(){for(let t=0,e=this.length;t<e;++t){const r=this[t]();if(r!==void 0)return r}}function kn(...t){let e=!1;for(let o=0;o<t.length;o++){const l=t[o];e=e||!!l&&Er in l,t[o]=typeof l=="function"?(e=!0,Re(l)):l}if(bn&&e)return new Proxy({get(o){for(let l=t.length-1;l>=0;l--){const c=pr(t[l])[o];if(c!==void 0)return c}},has(o){for(let l=t.length-1;l>=0;l--)if(o in pr(t[l]))return!0;return!1},keys(){const o=[];for(let l=0;l<t.length;l++)o.push(...Object.keys(pr(t[l])));return[...new Set(o)]}},Mn);const r={},n=Object.create(null);for(let o=t.length-1;o>=0;o--){const l=t[o];if(!l)continue;const c=Object.getOwnPropertyNames(l);for(let u=c.length-1;u>=0;u--){const f=c[u];if(f==="__proto__"||f==="constructor")continue;const d=Object.getOwnPropertyDescriptor(l,f);if(!n[f])n[f]=d.get?{enumerable:!0,configurable:!0,get:En.bind(r[f]=[d.get.bind(l)])}:d.value!==void 0?d:void 0;else{const v=r[f];v&&(d.get?v.push(d.get.bind(l)):d.value!==void 0&&v.push(()=>d.value))}}}const i={},s=Object.keys(n);for(let o=s.length-1;o>=0;o--){const l=s[o],c=n[l];c&&c.get?Object.defineProperty(i,l,c):i[l]=c?c.value:void 0}return i}const Rn=t=>`Stale read from <${t}>.`;function Xt(t){const e="fallback"in t&&{fallback:()=>t.fallback};return Re($n(()=>t.each,t.children,e||void 0))}function ie(t){const e=t.keyed,r=Re(()=>t.when,void 0,void 0),n=e?r:Re(r,void 0,{equals:(i,s)=>!i==!s});return Re(()=>{const i=n();if(i){const s=t.children;return typeof s=="function"&&s.length>0?lt(()=>s(e?i:()=>{if(!lt(n))throw Rn("Show");return r()})):s}return t.fallback},void 0,void 0)}const Ge=t=>Re(()=>t());function In(t,e,r){let n=r.length,i=e.length,s=n,o=0,l=0,c=e[i-1].nextSibling,u=null;for(;o<i||l<s;){if(e[o]===r[l]){o++,l++;continue}for(;e[i-1]===r[s-1];)i--,s--;if(i===o){const f=s<n?l?r[l-1].nextSibling:r[s-l]:c;for(;l<s;)t.insertBefore(r[l++],f)}else if(s===l)for(;o<i;)(!u||!u.has(e[o]))&&e[o].remove(),o++;else if(e[o]===r[s-1]&&r[l]===e[i-1]){const f=e[--i].nextSibling;t.insertBefore(r[l++],e[o++].nextSibling),t.insertBefore(r[--s],f),e[i]=r[s]}else{if(!u){u=new Map;let d=l;for(;d<s;)u.set(r[d],d++)}const f=u.get(e[o]);if(f!=null)if(l<f&&f<s){let d=o,v=1,x;for(;++d<i&&d<s&&!((x=u.get(e[d]))==null||x!==f+v);)v++;if(v>f-l){const T=e[o];for(;l<f;)t.insertBefore(r[l++],T)}else t.replaceChild(r[l++],e[o++])}else o++;else e[o++].remove()}}}const Nr="_$DX_DELEGATE";function An(t,e,r,n={}){let i;return Dt(s=>{i=s,e===document?t():m(e,t(),e.firstChild?null:void 0,r)},n.owner),()=>{i(),e.textContent=""}}function L(t,e,r,n){let i;const s=()=>{const l=document.createElement("template");return l.innerHTML=t,l.content.firstChild},o=()=>(i||(i=s())).cloneNode(!0);return o.cloneNode=o,o}function yt(t,e=window.document){const r=e[Nr]||(e[Nr]=new Set);for(let n=0,i=t.length;n<i;n++){const s=t[n];r.has(s)||(r.add(s),e.addEventListener(s,Pn))}}function Lt(t,e,r){r==null?t.removeAttribute(e):t.setAttribute(e,r)}function oe(t,e){e==null?t.removeAttribute("class"):t.className=e}function sn(t,e,r,n){Array.isArray(r)?(t[`$$${e}`]=r[0],t[`$$${e}Data`]=r[1]):t[`$$${e}`]=r}function Dn(t,e,r={}){const n=Object.keys(e||{}),i=Object.keys(r);let s,o;for(s=0,o=i.length;s<o;s++){const l=i[s];!l||l==="undefined"||e[l]||(Vr(t,l,!1),delete r[l])}for(s=0,o=n.length;s<o;s++){const l=n[s],c=!!e[l];!l||l==="undefined"||r[l]===c||!c||(Vr(t,l,!0),r[l]=c)}return r}function Fn(t,e,r){if(!e)return r?Lt(t,"style"):e;const n=t.style;if(typeof e=="string")return n.cssText=e;typeof r=="string"&&(n.cssText=r=void 0),r||(r={}),e||(e={});let i,s;for(s in r)e[s]==null&&n.removeProperty(s),delete r[s];for(s in e)i=e[s],i!==r[s]&&(n.setProperty(s,i),r[s]=i);return r}function Le(t,e,r){r!=null?t.style.setProperty(e,r):t.style.removeProperty(e)}function at(t,e,r){return lt(()=>t(e,r))}function m(t,e,r,n){if(r!==void 0&&!n&&(n=[]),typeof e!="function")return Jt(t,e,n,r);Q(i=>Jt(t,e(),i,r),n)}function Vr(t,e,r){const n=e.trim().split(/\s+/);for(let i=0,s=n.length;i<s;i++)t.classList.toggle(n[i],r)}function Pn(t){let e=t.target;const r=`$$${t.type}`,n=t.target,i=t.currentTarget,s=c=>Object.defineProperty(t,"target",{configurable:!0,value:c}),o=()=>{const c=e[r];if(c&&!e.disabled){const u=e[`${r}Data`];if(u!==void 0?c.call(e,u,t):c.call(e,t),t.cancelBubble)return}return e.host&&typeof e.host!="string"&&!e.host._$host&&e.contains(t.target)&&s(e.host),!0},l=()=>{for(;o()&&(e=e._$host||e.parentNode||e.host););};if(Object.defineProperty(t,"currentTarget",{configurable:!0,get(){return e||document}}),t.composedPath){const c=t.composedPath();s(c[0]);for(let u=0;u<c.length-2&&(e=c[u],!!o());u++){if(e._$host){e=e._$host,l();break}if(e.parentNode===i)break}}else l();s(n)}function Jt(t,e,r,n,i){for(;typeof r=="function";)r=r();if(e===r)return r;const s=typeof e,o=n!==void 0;if(t=o&&r[0]&&r[0].parentNode||t,s==="string"||s==="number"){if(s==="number"&&(e=e.toString(),e===r))return r;if(o){let l=r[0];l&&l.nodeType===3?l.data!==e&&(l.data=e):l=document.createTextNode(e),r=Ct(t,r,n,l)}else r!==""&&typeof r=="string"?r=t.firstChild.data=e:r=t.textContent=e}else if(e==null||s==="boolean")r=Ct(t,r,n);else{if(s==="function")return Q(()=>{let l=e();for(;typeof l=="function";)l=l();r=Jt(t,l,r,n)}),()=>r;if(Array.isArray(e)){const l=[],c=r&&Array.isArray(r);if(kr(l,e,r,i))return Q(()=>r=Jt(t,l,r,n,!0)),()=>r;if(l.length===0){if(r=Ct(t,r,n),o)return r}else c?r.length===0?Or(t,l,n):In(t,r,l):(r&&Ct(t),Or(t,l));r=l}else if(e.nodeType){if(Array.isArray(r)){if(o)return r=Ct(t,r,n,e);Ct(t,r,null,e)}else r==null||r===""||!t.firstChild?t.appendChild(e):t.replaceChild(e,t.firstChild);r=e}}return r}function kr(t,e,r,n){let i=!1;for(let s=0,o=e.length;s<o;s++){let l=e[s],c=r&&r[t.length],u;if(!(l==null||l===!0||l===!1))if((u=typeof l)=="object"&&l.nodeType)t.push(l);else if(Array.isArray(l))i=kr(t,l,c)||i;else if(u==="function")if(n){for(;typeof l=="function";)l=l();i=kr(t,Array.isArray(l)?l:[l],Array.isArray(c)?c:[c])||i}else t.push(l),i=!0;else{const f=String(l);c&&c.nodeType===3&&c.data===f?t.push(c):t.push(document.createTextNode(f))}}return i}function Or(t,e,r=null){for(let n=0,i=e.length;n<i;n++)t.insertBefore(e[n],r)}function Ct(t,e,r,n){if(r===void 0)return t.textContent="";const i=n||document.createTextNode("");if(e.length){let s=!1;for(let o=e.length-1;o>=0;o--){const l=e[o];if(i!==l){const c=l.parentNode===t;!s&&!o?c?t.replaceChild(i,l):t.insertBefore(i,r):c&&l.remove()}else s=!0}}else t.insertBefore(i,r);return[i]}const Ar=()=>typeof navigator>"u"||!Number.isFinite(navigator.hardwareConcurrency)?4:Math.max(1,Math.floor(navigator.hardwareConcurrency)),Ln=t=>Math.max(1,Math.min(Ar(),Math.floor(t)));function Bn(){const t=Ar(),e=t<=2?1:Math.min(4,Math.max(2,t-2)),[r,n]=$("idle"),[i,s]=$(0),[o,l]=$([]),[c,u]=$("");let f;const[d,v]=$("unloaded"),[x,T]=$("parakeet-tdt-0.6b-v2"),[w,S]=$("webgpu-hybrid"),[M,k]=$("fp32"),[p,R]=$("int8"),[A,H]=$(0),[W,D]=$(""),[P,N]=$(""),[G,Y]=$("webgpu"),[_,h]=$(null),[g,b]=$(""),[C,E]=$(""),[I,F]=$(0),[Z,z]=$(new Float32Array(0)),[te,re]=$(!1),[ae,ve]=$(!1),[he,ue]=$(typeof navigator<"u"?navigator.onLine:!0),[X,be]=$(0),[J,Te]=$([]),_e=5,et=K=>{be(K),Te(de=>[...de.slice(1-_e),K])},qe=Re(()=>{const K=J();return K.length===0?X():K.reduce((de,Ie)=>de+Ie,0)/K.length}),[De,ye]=$([]),[Qe,Oe]=$({throughput:0,modelConfidence:0}),[Ye,Fe]=$("v4-utterance"),[Mt,Et]=$({lcsLength:0,anchorValid:!1,chunkCount:0,anchorTokens:[]}),[tt,St]=$(0),[kt,xt]=$([]),y=10,V=K=>{St(K),xt(de=>[...de.slice(1-y),K])},ne=Re(()=>{const K=kt().filter(de=>de>0);return K.length===0?0:K.reduce((de,Ie)=>de+1/Ie,0)/K.length}),[Se,U]=$({fillRatio:0,latencyMs:0}),[fe,ge]=$(5),[ce,se]=$(3.5),[Me,j]=$(1.5),[ze,ke]=$(.08),[Pe,Ze]=$(1),[xe,Be]=$(e),[rt,nt]=$(480),[Ee,Ne]=$(1),[it,dt]=$(.5),[wt,q]=$(!1),[Ke,We]=$(""),[st,Ue]=$(""),[ht,B]=$(0),[ut,ft]=$({isSpeech:!1,energy:0,snr:0,sileroProbability:0,hybridState:"silence"}),[gt,Nt]=$({sentencesFinalized:0,cursorUpdates:0,utterancesProcessed:0}),[Vt,mt]=$([]);if(typeof window<"u"){const K=()=>ue(!0),de=()=>ue(!1);window.addEventListener("online",K),window.addEventListener("offline",de),bt(()=>{window.removeEventListener("online",K),window.removeEventListener("offline",de)})}return{recordingState:r,availableDevices:o,selectedDeviceId:c,sessionDuration:i,modelState:d,selectedModelId:x,modelBackendMode:w,encoderQuant:M,decoderQuant:p,modelProgress:A,modelMessage:W,modelFile:P,backend:G,transcript:g,pendingText:C,audioLevel:I,barLevels:Z,setBarLevels:z,isSpeechDetected:te,isOfflineReady:ae,isOnline:he,inferenceLatency:X,inferenceLatencyAverage:qe,rtf:tt,rtfxAverage:ne,bufferMetrics:Se,debugTokens:De,systemMetrics:Qe,errorMessage:_,transcriptionMode:Ye,mergeInfo:Mt,streamingWindow:fe,streamingOverlap:ce,triggerInterval:Me,energyThreshold:ze,frameStride:Pe,wasmThreads:xe,v4InferenceIntervalMs:rt,v4SilenceFlushSec:Ee,sileroThreshold:it,showDebugPanel:wt,matureText:Ke,immatureText:st,matureCursorTime:ht,vadState:ut,v4MergerStats:gt,v4SentenceEntries:Vt,setRecordingState:n,setSessionDuration:s,setAvailableDevices:l,setSelectedDeviceId:u,setModelState:v,setSelectedModelId:T,setModelBackendMode:S,setEncoderQuant:k,setDecoderQuant:R,setModelProgress:H,setModelMessage:D,setModelFile:N,setBackend:Y,setErrorMessage:h,setTranscript:b,setPendingText:E,setAudioLevel:F,setIsSpeechDetected:re,setIsOfflineReady:ve,setInferenceLatency:et,setRtf:V,setBufferMetrics:U,setDebugTokens:ye,setSystemMetrics:Oe,setTranscriptionMode:Fe,setMergeInfo:Et,setStreamingWindow:ge,setStreamingOverlap:se,setTriggerInterval:j,setEnergyThreshold:ke,setFrameStride:Ze,setWasmThreads:Be,setShowDebugPanel:q,setV4InferenceIntervalMs:nt,setV4SilenceFlushSec:Ne,setSileroThreshold:dt,setMatureText:We,setImmatureText:Ue,setMatureCursorTime:B,setVadState:ft,setV4MergerStats:Nt,setV4SentenceEntries:mt,startRecording:()=>{n("recording"),s(0),f&&clearInterval(f),f=window.setInterval(()=>{s(K=>K+1)},1e3)},stopRecording:()=>{n("idle"),f&&(clearInterval(f),f=void 0)},refreshDevices:async K=>{try{if(typeof navigator>"u"||!navigator.mediaDevices?.enumerateDevices){l([]);return}const Ie=(await navigator.mediaDevices.enumerateDevices()).filter(Xe=>Xe.kind==="audioinput");if(l(Ie),Ie.length===0)return;const Fr=c();if(Fr.length>0&&Ie.some(Xe=>Xe.deviceId===Fr))return;const Pr=K?.preferredDeviceId?.trim();if(Pr){const Xe=Ie.find(fr=>fr.deviceId===Pr);if(Xe){u(Xe.deviceId);return}}const ur=K?.preferredDeviceLabel?.trim().toLowerCase();if(ur){const Xe=Ie.find(fr=>{const gr=fr.label.trim().toLowerCase();return gr?gr===ur?!0:gr.includes(ur):!1});if(Xe){u(Xe.deviceId);return}}u(Ie[0].deviceId)}catch(de){console.error("Failed to enum devices:",de)}},appendTranscript:K=>{b(de=>de+K),E("")},clearTranscript:()=>{b(""),E(""),We(""),Ue(""),B(0),mt([])},appendV4SentenceEntries:K=>{!Array.isArray(K)||K.length===0||mt(de=>[...de,...K])},clearV4SentenceEntries:()=>{mt([])},copyTranscript:async()=>{try{return await navigator.clipboard.writeText(g()),!0}catch{return!1}}}}const a=Dt(Bn),on=-11,Nn=0,Vn=Nn-on;function On(t){const e=(t-on)/Vn;return Math.max(0,Math.min(1,e))}var zn=L('<div class="relative w-full bg-slate-900 rounded border border-slate-700 overflow-hidden shadow-inner"><canvas class="w-full h-full block"></canvas><div class="absolute top-2 left-2 text-[10px] text-slate-400 pointer-events-none">SPECTROGRAM + WAVEFORM (<!>s)');const vr=(()=>{const t=[[0,0,0,0],[.12,0,0,180],[.3,120,0,160],[.48,0,180,80],[.65,220,220,0],[.82,255,140,0],[1,255,0,0]],e=new Uint8Array(256*3);for(let r=0;r<256;r++){const n=r/255;let i=0,s=0,o=0;for(let c=0;c<t.length-1;c++){const[u,f,d,v]=t[c],[x,T,w,S]=t[c+1];if(n>=u&&n<=x){const M=(n-u)/(x-u);i=Math.round(f+M*(T-f)),s=Math.round(d+M*(w-d)),o=Math.round(v+M*(S-v));break}}if(n>=t[t.length-1][0]){const c=t[t.length-1];i=c[1],s=c[2],o=c[3]}const l=r*3;e[l]=i,e[l+1]=s,e[l+2]=o}return e})(),Wn=t=>{let e,r=null,n,i=!1;const s=()=>t.windowDuration||8;let o,l=null,c=0;const u=100,f=33;let d=0,v=0,x=0,T=window.devicePixelRatio||1,w=null,S=null,M=null;const k=(h,g)=>{T=window.devicePixelRatio||1,v=Math.floor(h*T),x=Math.floor(g*T),e&&(e.width!==v||e.height!==x)&&(e.width=v,e.height=x),o&&(o.width!==v||o.height!==x)&&(o.width=v,o.height=x)};let p=null,R=0,A=0,H=null,W=null;Rr(()=>{if(i=!1,e){r=e.getContext("2d",{alpha:!1}),w=new ResizeObserver(b=>{for(const C of b){const E=C.contentRect;k(E.width,E.height)}}),w.observe(e);const h=()=>{S&&M&&S.removeEventListener("change",M),S=window.matchMedia(`(resolution: ${window.devicePixelRatio}dppx)`);const b=()=>{if(!i){if(e){const C=e.getBoundingClientRect();k(C.width,C.height)}h()}};M=b,S.addEventListener("change",b,{once:!0})};h();const g=e.getBoundingClientRect();k(g.width,g.height)}o=document.createElement("canvas"),l=o.getContext("2d",{alpha:!1}),D()}),bt(()=>{i=!0,cancelAnimationFrame(n),w&&(w.disconnect(),w=null),S&&M&&S.removeEventListener("change",M),S=null,M=null});const D=(h=performance.now())=>{if(i)return;if(!r||!e||!t.audioEngine){n=requestAnimationFrame(D);return}if(h-d<f){n=requestAnimationFrame(D);return}d=h;const g=T,b=v,C=x;if(b===0||C===0){n=requestAnimationFrame(D);return}const E="#0f172a";r.fillStyle=E,r.fillRect(0,0,b,C);const I=t.audioEngine.getRingBuffer(),F=I.getCurrentTime(),Z=s(),z=F-Z,te=I.sampleRate,re=Math.floor(C*.55),ae=Math.floor(C*.35),ve=C-re-ae,he=re,ue=re+ae;if(t.melClient&&l&&o){if(h-c>u){c=h;const X=Math.round(z*te),be=Math.round(F*te);t.melClient.getFeatures(X,be,!1).then(J=>{i||J&&l&&o&&(W={features:J.features,melBins:J.melBins,timeSteps:J.T,startTime:z,endTime:F},P(l,J.features,J.melBins,J.T,b,re))}).catch(()=>{})}if(W&&W.timeSteps>0){const X=W.endTime-W.startTime,be=z-W.startTime,J=Math.floor(be/X*b);r.drawImage(o,J,0,b-J,re,0,0,b-J,re)}}try{const X=Math.floor(z*te),be=Math.floor(F*te),J=be-X,Te=I.getBaseFrameOffset();if(X>=Te&&J>0)if(I.readInto){(!H||H.length<J)&&(H=new Float32Array(J));const _e=I.readInto(X,be,H);G(r,H.subarray(0,_e),b,ae,he)}else{const _e=I.read(X,be);G(r,_e,b,ae,he)}}catch{}Y(r,b,ve,ue,z,Z,g),_(r,b,C,z,Z,g),n=requestAnimationFrame(D)},P=(h,g,b,C,E,I)=>{if(C===0)return;(!p||R!==E||A!==I)&&(p=h.createImageData(E,I),R=E,A=I);const F=p,Z=F.data,z=C/E,te=b/I;for(let re=0;re<E;re++){const ae=Math.floor(re*z);if(ae>=C)break;for(let ve=0;ve<I;ve++){const he=Math.floor((I-1-ve)*te);if(he>=b)continue;const ue=g[he*C+ae],J=(On(ue)*255|0)*3,Te=(ve*E+re)*4;Z[Te]=vr[J],Z[Te+1]=vr[J+1],Z[Te+2]=vr[J+2],Z[Te+3]=255}}h.putImageData(F,0,0)},N=1,G=(h,g,b,C,E)=>{if(g.length===0)return;const I=Math.ceil(g.length/b),F=C/2*N,Z=E+C/2;h.strokeStyle="#4ade80",h.lineWidth=1,h.beginPath();for(let z=0;z<b;z++){const te=z*I,re=Math.min((z+1)*I,g.length);let ae=1,ve=-1,he=!1;for(let ue=te;ue<re;ue+=Math.max(1,Math.floor((re-te)/10))){const X=g[ue];X<ae&&(ae=X),X>ve&&(ve=X),he=!0}if(he){const ue=Z-ae*F,X=Z-ve*F;h.moveTo(z,Math.max(E,Math.min(E+C,ue))),h.lineTo(z,Math.max(E,Math.min(E+C,X)))}}h.stroke()},Y=(h,g,b,C,E,I,F)=>{const z=a.vadState().isSpeech;h.fillStyle=z?"rgba(249, 115, 22, 0.4)":"rgba(100, 116, 139, 0.2)",h.fillRect(0,C,g,b);const te=a.audioLevel(),re=a.energyThreshold();if(te>0){const ae=Math.min(g,g*(te/.3));h.fillStyle=te>re?"rgba(249, 115, 22, 0.8)":"rgba(74, 222, 128, 0.6)",h.fillRect(g-ae,C,ae,b)}h.strokeStyle="rgba(148, 163, 184, 0.3)",h.lineWidth=1*F,h.beginPath(),h.moveTo(0,C),h.lineTo(g,C),h.stroke(),h.fillStyle=z?"#fb923c":"#64748b",h.font=`${8*F}px monospace`,h.fillText(z?"SPEECH":"SILENCE",4*F,C+b-2*F)},_=(h,g,b,C,E,I)=>{const F=g-1.5/E*g;h.strokeStyle="rgba(255, 255, 0, 0.5)",h.lineWidth=1*I,h.beginPath(),h.moveTo(F,0),h.lineTo(F,b),h.stroke(),h.fillStyle="#94a3b8",h.font=`${10*I}px monospace`;for(let Z=0;Z<=8;Z+=2){const z=Z,te=g-z/E*g;h.fillText(`-${z}s`,te+3*I,b-6*I)}};return(()=>{var h=zn(),g=h.firstChild,b=g.nextSibling,C=b.firstChild,E=C.nextSibling;E.nextSibling;var I=e;return typeof I=="function"?at(I,g):e=g,m(b,s,E),Q(F=>Le(h,"height",`${t.height||200}px`)),h})()};yt(["click"]);const an="keet-app-settings",Un="boncukjs-control-widget-pos",Hn="keet-merged-split-ratio",er=120,Ft=520,ln=220,jn=.3,Gn=.7,cn=.5,ot=t=>typeof t=="object"&&t!==null,rr=(t,e,r)=>Math.min(r,Math.max(e,t)),_t=t=>{if(!(typeof t!="number"||!Number.isFinite(t)))return t},zt=(t,e,r)=>{const n=_t(t);if(n!==void 0)return rr(n,e,r)},br=(t,e,r)=>{const n=_t(t);if(n!==void 0)return Math.round(rr(n,e,r))},yr=t=>{if(typeof t!="string")return;const e=t.trim();return e.length>0?e:void 0},qn=t=>{if(typeof t=="boolean")return t},dn=t=>rr(t,er,Ft),Tt=t=>rr(t,jn,Gn),hn=t=>{if(!ot(t))return;const e=_t(t.x),r=_t(t.y);if(!(e===void 0||r===void 0))return{x:e,y:r}},Qn=t=>{if(t==="live"||t==="merged")return t},Yn=t=>{if(t==="webgpu-hybrid"||t==="wasm")return t},zr=t=>{if(t==="int8"||t==="fp32")return t},Zn=t=>{if(!ot(t))return{};const e={},r=ot(t.general)?t.general:null;if(r){const o={};o.energyThreshold=zt(r.energyThreshold,.005,.3),o.sileroThreshold=zt(r.sileroThreshold,.1,.9),o.v4InferenceIntervalMs=br(r.v4InferenceIntervalMs,160,8e3),o.v4SilenceFlushSec=zt(r.v4SilenceFlushSec,.3,5),o.streamingWindow=zt(r.streamingWindow,2,15),o.frameStride=br(r.frameStride,1,4),o.wasmThreads=br(r.wasmThreads,1,64),Object.values(o).some(l=>l!==void 0)&&(e.general=o)}const n=ot(t.model)?t.model:null;if(n){const o=yr(n.selectedModelId),l=Yn(n.backend),c=zr(n.encoderQuant),u=zr(n.decoderQuant);(o||l||c||u)&&(e.model={},o&&(e.model.selectedModelId=o),l&&(e.model.backend=l),c&&(e.model.encoderQuant=c),u&&(e.model.decoderQuant=u))}const i=ot(t.audio)?t.audio:null;if(i){const o=yr(i.selectedDeviceId),l=yr(i.selectedDeviceLabel);(o||l)&&(e.audio={},o&&(e.audio.selectedDeviceId=o),l&&(e.audio.selectedDeviceLabel=l))}const s=ot(t.ui)?t.ui:null;if(s){const o={},l=hn(s.widgetPosition);l&&(o.widgetPosition=l);const c=ot(s.debugPanel)?s.debugPanel:null;if(c){const f=qn(c.visible),d=_t(c.height),v=d===void 0?void 0:dn(d);(f!==void 0||v!==void 0)&&(o.debugPanel={},f!==void 0&&(o.debugPanel.visible=f),v!==void 0&&(o.debugPanel.height=v))}const u=ot(s.transcript)?s.transcript:null;if(u){const f=Qn(u.activeTab),d=_t(u.mergedSplitRatio),v=d===void 0?void 0:Tt(d);(f||v!==void 0)&&(o.transcript={},f&&(o.transcript.activeTab=f),v!==void 0&&(o.transcript.mergedSplitRatio=v))}(o.widgetPosition||o.debugPanel||o.transcript)&&(e.ui=o)}return e},Kn=()=>{if(!(typeof localStorage>"u"))try{const t=localStorage.getItem(Un);return t?hn(JSON.parse(t)):void 0}catch{return}},Xn=()=>{if(!(typeof localStorage>"u"))try{const t=localStorage.getItem(Hn);if(!t)return;const e=Number(t);return Number.isFinite(e)?Tt(e):void 0}catch{return}},Jn=()=>{if(typeof localStorage>"u")return{};let t=null;try{const i=localStorage.getItem(an);i&&(t=JSON.parse(i))}catch{t=null}const e=Zn(t),r=Kn(),n=Xn();return r&&!e.ui?.widgetPosition&&(e.ui=e.ui??{},e.ui.widgetPosition=r),n!==void 0&&!e.ui?.transcript?.mergedSplitRatio&&(e.ui=e.ui??{},e.ui.transcript=e.ui.transcript??{},e.ui.transcript.mergedSplitRatio=n),e},Wr=t=>{if(!(typeof localStorage>"u"))try{localStorage.setItem(an,JSON.stringify(t))}catch{}};var ei=L('<p class="text-sm md:text-base lg:text-[1.05rem] text-[var(--color-earthy-dark-brown)] leading-7">'),ti=L('<p class="text-sm text-[var(--color-earthy-soft-brown)] italic opacity-70">Waiting for transcript text...'),ri=L('<div class="grid grid-cols-1 sm:grid-cols-[86px_138px_1fr] xl:grid-cols-[94px_150px_1fr] gap-1.5 sm:gap-3 items-baseline px-1 py-1 rounded-lg bg-[var(--color-earthy-muted-green)]/10 border border-[var(--color-earthy-sage)]/40"><span class="font-mono text-xs text-[var(--color-earthy-soft-brown)]"></span><span class="text-[10px] font-semibold uppercase tracking-wide text-[var(--color-earthy-coral)]">LIVE</span><span class="text-sm md:text-base text-[var(--color-earthy-coral)] italic">'),ni=L("<div class=space-y-0.5>"),ii=L('<div class="flex flex-col items-center justify-center h-full opacity-50 py-6"><span class="material-symbols-outlined text-3xl mb-2 text-[var(--color-earthy-soft-brown)]">view_list</span><p class="text-sm text-[var(--color-earthy-soft-brown)] italic">No merged conversation entries yet...'),si=L('<div class="grid grid-cols-1 sm:grid-cols-[86px_138px_1fr] xl:grid-cols-[94px_150px_1fr] gap-1.5 sm:gap-3 items-baseline px-1 py-1 rounded-lg hover:bg-[var(--color-earthy-sage)]/10 transition-colors"><span class="font-mono text-xs text-[var(--color-earthy-soft-brown)]"></span><span class="font-mono text-xs text-[var(--color-earthy-soft-brown)]">[<!>]</span><span class="text-sm md:text-base text-[var(--color-earthy-dark-brown)]">'),oi=L('<div class="flex-1 overflow-y-auto scroll-smooth flex flex-col min-h-0"><div class="story-font py-0 space-y-1 flex-1 flex flex-col min-h-0"><div class="flex flex-col gap-1 lg:hidden min-h-0 flex-1"><div class="flex-1 min-h-0 px-1 py-1 rounded-lg border border-[var(--color-earthy-sage)]/40 bg-[var(--color-earthy-sage)]/10 flex flex-col"><div class="text-[10px] font-semibold uppercase tracking-widest text-[var(--color-earthy-soft-brown)] mb-0.5 shrink-0">Full Text Body</div><div class="flex-1 min-h-0 overflow-y-auto custom-scrollbar pr-0.5"></div></div><div class="flex-1 min-h-0 px-1 py-1 rounded-lg border border-[var(--color-earthy-sage)]/40 bg-[var(--color-earthy-bg)]/60 flex flex-col"><div class="text-[10px] font-semibold uppercase tracking-widest text-[var(--color-earthy-soft-brown)] mb-0.5 shrink-0">Sentence List</div><div class="flex-1 min-h-0 overflow-y-auto custom-scrollbar pr-0.5"></div></div></div><div class="hidden lg:flex items-stretch flex-1 min-h-0"><div class="min-w-0 px-1 py-1 rounded-l-lg border border-[var(--color-earthy-sage)]/40 bg-[var(--color-earthy-sage)]/10 flex flex-col"><div class="text-[10px] font-semibold uppercase tracking-widest text-[var(--color-earthy-soft-brown)] mb-0.5 shrink-0">Full Text Body</div><div class="flex-1 min-h-0 overflow-y-auto custom-scrollbar pr-0.5"></div></div><div class="w-3 shrink-0 relative cursor-col-resize group touch-none"role=separator aria-orientation=vertical aria-label="Adjust merged split"><div></div><div></div></div><div class="min-w-0 px-1 py-1 rounded-r-lg border border-[var(--color-earthy-sage)]/40 bg-[var(--color-earthy-bg)]/60 flex flex-col"><div class="text-[10px] font-semibold uppercase tracking-widest text-[var(--color-earthy-soft-brown)] mb-0.5 shrink-0">Sentence List</div><div class="flex-1 min-h-0 overflow-y-auto custom-scrollbar pr-0.5">'),ai=L('<div class="mt-4 flex items-center gap-4 text-[10px] font-bold text-[var(--color-earthy-soft-brown)] uppercase tracking-widest bg-[var(--color-earthy-bg)]/80 backdrop-blur-sm self-start px-4 py-2 rounded-full border border-[var(--color-earthy-sage)]/50"><div class="flex items-center gap-1.5"><span></span><span>LCS: </span></div><div class="w-px h-3 bg-[var(--color-earthy-sage)]"></div><span class=opacity-60>PTFA Merged'),li=L("<div>"),ci=L('<span class="text-2xl md:text-3xl leading-[1.6] text-[var(--color-earthy-coral)] font-medium italic ml-1 transition-all duration-300"><span class="inline-block w-[3px] h-8 bg-[var(--color-earthy-coral)] align-middle ml-1 opacity-60 animate-pulse">'),di=L('<div class="flex items-center gap-3"><div class="w-2 h-2 rounded-full bg-[var(--color-earthy-coral)] animate-pulse"></div><span class="text-[10px] font-semibold uppercase tracking-widest text-[var(--color-earthy-soft-brown)]">Listening...</span><div class="flex gap-1"><div class="w-1.5 h-1.5 bg-[var(--color-earthy-muted-green)] rounded-full animate-bounce opacity-60"></div><div class="w-1.5 h-1.5 bg-[var(--color-earthy-muted-green)] rounded-full animate-bounce opacity-80 [animation-delay:0.2s]"></div><div class="w-1.5 h-1.5 bg-[var(--color-earthy-muted-green)] rounded-full animate-bounce [animation-delay:0.4s]">'),hi=L('<div class="story-font space-y-12 py-4"><div class=group><div class="pl-4 border-l-2 border-[var(--color-earthy-coral)]/30 group-hover:border-[var(--color-earthy-coral)]/50 transition-colors duration-300"><p class="text-2xl md:text-3xl leading-[1.6] text-[var(--color-earthy-dark-brown)] font-normal inline">'),ui=L('<div class="flex-1 overflow-y-auto scroll-smooth">'),fi=L('<div class="flex flex-col items-center justify-center h-full opacity-50 story-font"><span class="material-symbols-outlined text-5xl mb-4 text-[var(--color-earthy-soft-brown)]">graphic_eq</span><p class="text-2xl md:text-3xl leading-[1.6] text-[var(--color-earthy-muted-green)] italic">');const Ur=t=>Number.isFinite(t)?new Date(t).toLocaleTimeString([],{hour12:!1,hour:"2-digit",minute:"2-digit",second:"2-digit"}):"--:--:--",Hr=t=>{if(!Number.isFinite(t))return"0:00.00";const e=Math.max(0,t),r=Math.floor(e/60),n=(e%60).toFixed(2).padStart(5,"0");return`${r}:${n}`},gi=(t,e)=>`${Hr(t)} -> ${Hr(e)}`,mi=t=>{let e,r,n,i,s,o=!1;const[l,c]=$("live"),u=()=>t.activeTab??l(),f=_=>{if(t.onTabChange){t.onTabChange(_);return}c(_)},[d,v]=$(cn),x=()=>Tt(t.mergedSplitRatio??d()),T=_=>{const h=Tt(_);if(t.onMergedSplitRatioChange){t.onMergedSplitRatioChange(h);return}v(h)},[w,S]=$(!1);let M=null,k=null;const p=()=>{o||(o=!0,requestAnimationFrame(()=>{o=!1;const _=u()==="merged"?r:e;_&&(_.scrollTop=_.scrollHeight)}))},R=()=>i&&i.offsetParent!==null?i:s&&s.offsetParent!==null?s:i??s,A=()=>{requestAnimationFrame(()=>{const _=R();_&&(_.scrollTop=_.scrollHeight)})},H=_=>{if(!n)return;_.preventDefault();const h=n.getBoundingClientRect();if(h.width<=0)return;S(!0),document.body.style.cursor="col-resize",document.body.style.userSelect="none";const g=E=>{const I=Tt((E-h.left)/h.width);T(I)},b=E=>{g(E.clientX)},C=()=>{S(!1),document.body.style.cursor="",document.body.style.userSelect="",window.removeEventListener("mousemove",b),window.removeEventListener("mouseup",C),M=null,k=null};M=b,k=C,window.addEventListener("mousemove",b),window.addEventListener("mouseup",C)};Ve(()=>{!t.isV4Mode&&u()!=="live"&&f("live")});const W=Re(()=>(t.confirmedText?.length??0)>0||(t.pendingText?.length??0)>0),D=Re(()=>t.sentenceEntries??[]),P=Re(()=>t.isV4Mode&&u()!=="merged"?"":D().map(_=>_.text.trim()).filter(_=>_.length>0).join(" ").trim()),N=Re(()=>{const _=P(),h=t.pendingText.trim();return _&&h?`${_} ${h}`.trim():_||h||""});Ve(()=>{u(),t.confirmedText,t.pendingText,t.isRecording,D().length,p()}),Ve(()=>{!t.isV4Mode||u()!=="merged"||(D().length,t.pendingText,A())}),bt(()=>{document.body.style.cursor="",document.body.style.userSelect="",M&&window.removeEventListener("mousemove",M),k&&window.removeEventListener("mouseup",k)});const G=()=>O(ie,{get when(){return N().length>0},get fallback(){return ti()},get children(){var _=ei();return m(_,N),_}}),Y=()=>O(ie,{get when(){return D().length>0||!!t.pendingText.trim()},get fallback(){return ii()},get children(){var _=ni();return m(_,O(Xt,{get each(){return D()},children:h=>(()=>{var g=si(),b=g.firstChild,C=b.nextSibling,E=C.firstChild,I=E.nextSibling;I.nextSibling;var F=C.nextSibling;return m(b,()=>Ur(h.emittedAt)),m(C,()=>gi(h.startTime,h.endTime),I),m(F,()=>h.text),g})()}),null),m(_,O(ie,{get when(){return t.pendingText.trim()},get children(){var h=ri(),g=h.firstChild,b=g.nextSibling,C=b.nextSibling;return m(g,()=>Ur(Date.now())),m(C,()=>t.pendingText),h}}),null),_}});return(()=>{var _=li();return m(_,O(ie,{get when(){return Ge(()=>!!t.isV4Mode)()&&u()==="merged"},get fallback(){return(()=>{var h=ui(),g=e;return typeof g=="function"?at(g,h):e=h,m(h,O(ie,{get when(){return W()},get fallback(){return(()=>{var b=fi(),C=b.firstChild,E=C.nextSibling;return m(E,()=>t.placeholder??"Ready to transcribe..."),b})()},get children(){var b=hi(),C=b.firstChild,E=C.firstChild,I=E.firstChild;return m(I,()=>t.confirmedText),m(E,O(ie,{get when(){return t.pendingText},get children(){var F=ci(),Z=F.firstChild;return m(F,()=>t.pendingText,Z),F}}),null),m(b,O(ie,{get when(){return Ge(()=>!!(t.isRecording&&!t.pendingText))()&&!t.confirmedText},get children(){return di()}}),null),b}})),h})()},get children(){var h=oi(),g=h.firstChild,b=g.firstChild,C=b.firstChild,E=C.firstChild,I=E.nextSibling,F=C.nextSibling,Z=F.firstChild,z=Z.nextSibling,te=b.nextSibling,re=te.firstChild,ae=re.firstChild,ve=ae.nextSibling,he=re.nextSibling,ue=he.firstChild,X=ue.nextSibling,be=he.nextSibling,J=be.firstChild,Te=J.nextSibling,_e=r;typeof _e=="function"?at(_e,h):r=h,m(I,G);var et=s;typeof et=="function"?at(et,z):s=z,m(z,Y);var qe=n;typeof qe=="function"?at(qe,te):n=te,m(ve,G),he.$$mousedown=H;var De=i;return typeof De=="function"?at(De,Te):i=Te,m(Te,Y),Q(ye=>{var Qe=`calc(${(x()*100).toFixed(3)}% - 6px)`,Oe=`absolute inset-y-0 left-1/2 -translate-x-1/2 w-px transition-colors ${w()?"bg-[var(--color-earthy-muted-green)]":"bg-[var(--color-earthy-sage)]/70 group-hover:bg-[var(--color-earthy-soft-brown)]/80"}`,Ye=`absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-2.5 h-10 rounded-full border transition-colors ${w()?"bg-[var(--color-earthy-sage)] border-[var(--color-earthy-muted-green)]/80":"bg-[var(--color-earthy-bg)] border-[var(--color-earthy-sage)]/60 group-hover:border-[var(--color-earthy-soft-brown)]/80"}`,Fe=`calc(${((1-x())*100).toFixed(3)}% - 6px)`;return Qe!==ye.e&&Le(re,"width",ye.e=Qe),Oe!==ye.t&&oe(ue,ye.t=Oe),Ye!==ye.a&&oe(X,ye.a=Ye),Fe!==ye.o&&Le(be,"width",ye.o=Fe),ye},{e:void 0,t:void 0,a:void 0,o:void 0}),h}}),null),m(_,O(ie,{get when(){return Ge(()=>!!(t.showConfidence&&t.isRecording))()&&t.lcsLength!==void 0},get children(){var h=ai(),g=h.firstChild,b=g.firstChild,C=b.nextSibling;return C.firstChild,m(C,()=>t.lcsLength,null),Q(()=>oe(b,`w-2 h-2 rounded-full ${t.anchorValid?"bg-[var(--color-earthy-muted-green)]":"bg-[var(--color-earthy-coral)]"}`)),h}}),null),Q(()=>oe(_,`flex flex-col h-full bg-transparent ${t.class??""}`)),_})()};yt(["mousedown"]);var pi=L('<div class="h-12 w-full overflow-hidden rounded-md bg-[var(--color-earthy-bg)]"><canvas class="w-full h-full block">');const vi=t=>{let e,r=null,n,i=null,s=0,o=0,l="#faf8f5",c="#14b8a6";const u=33,f=120,d=250,v=()=>{if(!e?.parentElement)return;const w=e.parentElement.getBoundingClientRect(),S=window.devicePixelRatio||1,M=Math.floor(w.width*S),k=Math.floor(w.height*S);(e.width!==M||e.height!==k)&&(e.width=M,e.height=k)},x=()=>{if(!e)return;const w=getComputedStyle(e);l=w.getPropertyValue("--color-earthy-bg").trim()||"#faf8f5",c=w.getPropertyValue("--color-primary").trim()||"#14b8a6"},T=w=>{if(n=requestAnimationFrame(T),!r||!e)return;const M=typeof document<"u"&&document.visibilityState!=="visible"?d:t.isRecording?u:f;if(w-s<M)return;s=w,w-o>1e3&&(x(),o=w);const k=e.width,p=e.height;if(k===0||p===0)return;const R=t.barLevels,A=R&&R.length>0?R.length:0;if(r.fillStyle=l,r.fillRect(0,0,k,p),t.isRecording&&R&&A>0){const H=p/2,W=p/2*.9;r.strokeStyle=c,r.lineWidth=2,r.beginPath(),r.moveTo(0,H-Math.max(-1,Math.min(1,R[0]))*W);for(let D=1;D<A;D++){const P=D/(A-1)*k,N=H-Math.max(-1,Math.min(1,R[D]))*W;r.lineTo(P,N)}r.stroke()}};return Rr(()=>{e&&(v(),r=e.getContext("2d",{alpha:!1}),x(),(i=typeof ResizeObserver<"u"?new ResizeObserver(v):null)&&i.observe(e.parentElement??e)),n=requestAnimationFrame(T)}),bt(()=>{n!==void 0&&cancelAnimationFrame(n),i?.disconnect()}),(()=>{var w=pi(),S=w.firstChild,M=e;return typeof M=="function"?at(M,S):e=S,w})()},bi=t=>O(vi,kn(t,{get barCount(){return t.barLevels?.length}}));var yi=L('<button type=button class="absolute top-8 right-8 neu-square-btn text-[var(--color-earthy-soft-brown)] hover:text-[var(--color-earthy-coral)] transition-all z-10"aria-label=Close><span class="material-symbols-outlined text-xl">close'),Si=L("<span>"),xi=L('<div class=space-y-4><div class="grid gap-4"><button class="flex items-center text-left p-6 rounded-3xl nm-flat opacity-70 hover:opacity-100 transition-all hover:shadow-neu-btn-hover"><div class="w-10 h-10 rounded-2xl nm-inset flex items-center justify-center mr-5"><span class="material-symbols-outlined text-[var(--color-earthy-soft-brown)] text-xl">file_open</span></div><div><div class="font-bold text-lg leading-tight">Local Model</div><div class="text-[10px] font-black opacity-40 uppercase tracking-widest mt-1">Load from disk</div></div></button></div><button class="w-full mt-6 py-5 bg-[var(--color-earthy-muted-green)] text-white font-extrabold rounded-3xl shadow-xl active:scale-[0.98] transition-all uppercase tracking-widest text-xs">Initialize AI Engine'),wi=L('<div class=mt-4><div class="h-4 nm-inset rounded-full overflow-hidden p-1"><div class="h-full bg-[var(--color-earthy-muted-green)] rounded-full transition-all duration-300 ease-out shadow-[0_0_12px_var(--color-earthy-muted-green)]"></div></div><div class="flex justify-between items-center mt-6 px-1"><div class="flex flex-col"><span class="text-[10px] font-black text-[var(--color-earthy-soft-brown)] uppercase tracking-widest leading-none mb-1">Downloaded</span><span class="text-[var(--color-earthy-muted-green)] font-black text-2xl">%</span></div><div class="flex flex-col text-right"><span class="text-[10px] font-black text-[var(--color-earthy-soft-brown)] uppercase tracking-widest leading-none mb-1">Active File</span><span class="text-[var(--color-earthy-soft-brown)] font-bold text-[11px] truncate max-w-[200px]">'),Ci=L('<div><button class="w-full py-5 nm-flat text-[var(--color-earthy-coral)] font-black rounded-3xl shadow-none hover:opacity-90 transition-all">Retry Connection'),Ti=L('<div class="fixed inset-0 z-50 flex items-center justify-center bg-[var(--color-earthy-dark-brown)]/30 backdrop-blur-sm"role=dialog aria-modal=true aria-labelledby=model-overlay-title><input type=file multiple class=hidden><div class="w-full max-w-lg mx-4"><div class="relative nm-flat rounded-[40px] overflow-hidden transition-all duration-300 animate-in fade-in slide-in-from-bottom-4"><div class="p-10 pb-6 text-center"><div class="w-20 h-20 mx-auto mb-8 rounded-[32px] nm-inset flex items-center justify-center"></div><h2 id=model-overlay-title class="text-3xl font-extrabold text-[var(--color-earthy-dark-brown)] tracking-tight"></h2><p class="text-sm text-[var(--color-earthy-soft-brown)] font-medium mt-3 px-10"></p></div><div class="px-10 pb-10"></div><div class="px-10 py-6 border-t border-[var(--color-earthy-sage)]/30 flex items-center justify-between opacity-80"><div class="flex items-center gap-2"><span class="material-symbols-outlined text-base text-[var(--color-earthy-soft-brown)]">offline_bolt</span><span class="text-[10px] font-black text-[var(--color-earthy-soft-brown)] uppercase tracking-widest"></span></div><span class="text-[10px] text-[var(--color-earthy-sage)] font-black tracking-widest">PRIVACY SECURED'),_i=L('<span class="material-symbols-outlined text-[var(--color-earthy-coral)] text-4xl">warning'),$i=L('<div class="w-2.5 h-2.5 bg-[var(--color-earthy-muted-green)] rounded-full shadow-[0_0_8px_var(--color-earthy-muted-green)]">'),Mi=L('<button><div></div><div><div class="font-bold text-lg leading-tight"></div><div class="text-[10px] font-black opacity-40 uppercase tracking-widest mt-1">');const nr=[{id:"parakeet-tdt-0.6b-v2",name:"Parakeet v2",desc:"English optimized"},{id:"parakeet-tdt-0.6b-v3",name:"Parakeet v3",desc:"Multilingual Streaming"}];function un(t){return nr.find(e=>e.id===t)?.name??t}const Ei=t=>{const e=()=>`${Math.max(0,Math.min(100,t.progress))}%`;let r;const n=s=>{const o=s.target.files;o&&o.length>0&&t.onLocalLoad(o)},i=()=>t.onClose?.();return Ve(()=>{if(!t.isVisible||!t.onClose)return;const s=o=>{o.key==="Escape"&&(o.preventDefault(),t.onClose?.())};return document.addEventListener("keydown",s),()=>document.removeEventListener("keydown",s)}),O(ie,{get when(){return t.isVisible},get children(){var s=Ti(),o=s.firstChild,l=o.nextSibling,c=l.firstChild,u=c.firstChild,f=u.firstChild,d=f.nextSibling,v=d.nextSibling,x=u.nextSibling,T=x.nextSibling,w=T.firstChild,S=w.firstChild,M=S.nextSibling;s.$$click=p=>p.target===p.currentTarget&&i(),o.addEventListener("change",n);var k=r;return typeof k=="function"?at(k,o):r=o,m(c,O(ie,{get when(){return t.onClose},get children(){var p=yi();return p.$$click=i,p}}),u),m(f,O(ie,{get when(){return t.state!=="error"},get fallback(){return _i()},get children(){var p=Si();return m(p,()=>t.state==="loading"?"downloading":"neurology"),Q(()=>oe(p,`material-symbols-outlined text-[var(--color-earthy-muted-green)] text-4xl ${t.state==="loading"?"animate-pulse":""}`)),p}})),m(d,(()=>{var p=Ge(()=>t.state==="unloaded");return()=>p()?"Engine Selection":t.state==="error"?"Loading Failed":"Model Installation"})()),m(v,(()=>{var p=Ge(()=>t.state==="unloaded");return()=>p()?"Select the AI engine for this transcription session.":t.message})()),m(x,O(ie,{get when(){return t.state==="unloaded"},get children(){var p=xi(),R=p.firstChild,A=R.firstChild,H=R.nextSibling;return m(R,O(Xt,{each:nr,children:W=>(()=>{var D=Mi(),P=D.firstChild,N=P.nextSibling,G=N.firstChild,Y=G.nextSibling;return D.$$click=()=>t.onModelSelect(W.id),m(P,O(ie,{get when(){return t.selectedModelId===W.id},get children(){return $i()}})),m(G,()=>W.name),m(Y,()=>W.desc),Q(_=>{var h=`flex items-center text-left p-6 rounded-3xl transition-all ${t.selectedModelId===W.id?"nm-inset text-[var(--color-earthy-muted-green)] ring-2 ring-[var(--color-earthy-muted-green)]/20":"nm-flat text-[var(--color-earthy-dark-brown)] hover:shadow-neu-btn-hover"}`,g=`w-6 h-6 rounded-full nm-inset mr-5 flex flex-none items-center justify-center ${t.selectedModelId===W.id?"text-[var(--color-earthy-muted-green)]":"text-[var(--color-earthy-sage)]"}`;return h!==_.e&&oe(D,_.e=h),g!==_.t&&oe(P,_.t=g),_},{e:void 0,t:void 0}),D})()}),A),A.$$click=()=>r?.click(),H.$$click=()=>t.onStart(),p}}),null),m(x,O(ie,{get when(){return t.state==="loading"},get children(){var p=wi(),R=p.firstChild,A=R.firstChild,H=R.nextSibling,W=H.firstChild,D=W.firstChild,P=D.nextSibling,N=P.firstChild,G=W.nextSibling,Y=G.firstChild,_=Y.nextSibling;return m(P,()=>t.progress,N),m(_,()=>t.file||"Preparing assets..."),Q(h=>Le(A,"width",e())),p}}),null),m(x,O(ie,{get when(){return t.state==="error"},get children(){var p=Ci(),R=p.firstChild;return R.$$click=()=>t.onStart(),p}}),null),m(M,()=>t.backend==="webgpu"?"GPU Accelerated":"WASM Native"),s}})};yt(["click"]);var ki=L('<div class="bg-[var(--color-earthy-bg)] text-[10px] font-mono text-[var(--color-earthy-dark-brown)] flex flex-col overflow-hidden shrink-0 transition-colors duration-300 selection:bg-[var(--color-earthy-coral)]/20 selection:text-[var(--color-earthy-coral)]"><div class="h-3 shrink-0 cursor-row-resize group touch-none select-none flex items-center justify-center relative"role=separator aria-orientation=horizontal aria-label="Resize debug panel"><div></div></div><div class="flex flex-1 min-h-0 pt-1 px-2 pb-2 gap-2 overflow-hidden"><div class="rounded-md border border-[var(--color-earthy-sage)]/45 bg-[var(--color-earthy-bg)]/70 overflow-hidden w-60 flex flex-col p-2 gap-1.5 overflow-y-auto"><div class="flex flex-wrap gap-1"><span class="px-1.5 py-0.5 rounded-md border border-[var(--color-earthy-sage)]/45 bg-[var(--color-earthy-bg)] text-[8px] font-bold uppercase tracking-wider text-[var(--color-earthy-dark-brown)]">Mode v4</span><span class="px-1.5 py-0.5 rounded-md border border-[var(--color-earthy-sage)]/45 bg-[var(--color-earthy-bg)] text-[8px] font-bold uppercase tracking-wider text-[var(--color-earthy-soft-brown)]">Backend </span><span></span></div><div class=space-y-1><div class="flex justify-between font-bold text-[var(--color-earthy-soft-brown)] uppercase px-0.5 text-[9px]"><span>Buffer</span><span>%</span></div><div class="h-1.5 w-full bg-[var(--color-earthy-sage)] rounded-full overflow-hidden"><div class="h-full bg-[var(--color-earthy-muted-green)] transition-all duration-300 ease-out rounded-full"></div></div></div><div class="grid grid-cols-3 gap-1 pt-1 border-t border-[var(--color-earthy-sage)]/35"><div class="rounded-md border border-[var(--color-earthy-sage)]/45 bg-[var(--color-earthy-bg)]/95 h-full px-1 py-0.5 text-center"><div class="text-[7px] font-bold text-[var(--color-earthy-soft-brown)] uppercase">Sent</div><div class="text-[10px] font-bold text-[var(--color-earthy-dark-brown)]"></div></div><div class="rounded-md border border-[var(--color-earthy-sage)]/45 bg-[var(--color-earthy-bg)]/95 h-full px-1 py-0.5 text-center"><div class="text-[7px] font-bold text-[var(--color-earthy-soft-brown)] uppercase">Cursor</div><div class="text-[10px] font-bold text-[var(--color-earthy-dark-brown)]">s</div></div><div class="rounded-md border border-[var(--color-earthy-sage)]/45 bg-[var(--color-earthy-bg)]/95 h-full px-1 py-0.5 text-center"><div class="text-[7px] font-bold text-[var(--color-earthy-soft-brown)] uppercase">Win</div><div class="text-[10px] font-bold text-[var(--color-earthy-dark-brown)]"></div></div></div><div class="space-y-1 pt-1 border-t border-[var(--color-earthy-sage)]/35"><div class="flex justify-between font-bold text-[var(--color-earthy-soft-brown)] uppercase text-[9px]"><span>RMS Energy</span><span>%</span></div><div class="h-2 w-full bg-[var(--color-earthy-sage)] rounded overflow-hidden relative"><div class="absolute top-0 bottom-0 w-px bg-[var(--color-earthy-coral)] z-10"title="Energy threshold"></div><div></div></div></div><div><div class="flex justify-between font-bold text-[var(--color-earthy-soft-brown)] uppercase text-[9px]"><span>VAD Prob</span><span>%</span></div><div class="h-2 w-full bg-[var(--color-earthy-sage)] rounded overflow-hidden relative"><div class="absolute top-0 bottom-0 w-px bg-[var(--color-earthy-coral)] z-10"title="VAD threshold"></div><div></div></div></div></div><div class="rounded-md border border-[var(--color-earthy-sage)]/45 bg-[var(--color-earthy-bg)]/70 overflow-hidden flex-1 flex flex-col min-w-0"><div class="flex-1 overflow-y-auto p-2 space-y-2"><section class=space-y-1><div class="grid grid-cols-7 gap-1"><div class="rounded-md border border-[var(--color-earthy-sage)]/45 bg-[var(--color-earthy-bg)]/95 min-w-0 h-full p-1"><div class="text-[7px] font-bold uppercase text-[var(--color-earthy-soft-brown)] truncate">Inference Tick</div><div class="text-[10px] font-bold text-[var(--color-earthy-dark-brown)] truncate">ms</div></div><div class="rounded-md border border-[var(--color-earthy-sage)]/45 bg-[var(--color-earthy-bg)]/95 min-w-0 h-full p-1"><div class="text-[7px] font-bold uppercase text-[var(--color-earthy-soft-brown)] truncate">Silence Flush</div><div class="text-[10px] font-bold text-[var(--color-earthy-dark-brown)] truncate">s</div></div><div class="rounded-md border border-[var(--color-earthy-sage)]/45 bg-[var(--color-earthy-bg)]/95 min-w-0 h-full p-1"><div class="text-[7px] font-bold uppercase text-[var(--color-earthy-soft-brown)] truncate">VAD Threshold</div><div class="text-[10px] font-bold text-[var(--color-earthy-dark-brown)] truncate">%</div></div><div class="rounded-md border border-[var(--color-earthy-sage)]/45 bg-[var(--color-earthy-bg)]/95 min-w-0 h-full p-1"><div class="text-[7px] font-bold uppercase text-[var(--color-earthy-soft-brown)] truncate">RTFx</div><div></div></div><div class="rounded-md border border-[var(--color-earthy-sage)]/45 bg-[var(--color-earthy-bg)]/95 min-w-0 h-full p-1"><div class="text-[7px] font-bold uppercase text-[var(--color-earthy-soft-brown)] truncate">Latency</div><div class="text-[10px] font-bold text-[var(--color-earthy-dark-brown)] truncate">ms</div></div><div class="rounded-md border border-[var(--color-earthy-sage)]/45 bg-[var(--color-earthy-bg)]/95 min-w-0 h-full p-1"><div class="text-[7px] font-bold uppercase text-[var(--color-earthy-soft-brown)] truncate">State</div><div></div></div><div><div class="text-[7px] font-bold uppercase text-[var(--color-earthy-soft-brown)] truncate">SNR</div><div> dB</div></div></div></section><section class="pt-1 border-t border-[var(--color-earthy-sage)] space-y-1"><div class="text-[8px] text-[var(--color-earthy-soft-brown)]/80">Visualizes rolling 8-second context. Use this section for speech activity and spectral continuity checks.');const Ri=t=>{const e=()=>a.recordingState()==="recording",r="px-1.5 py-0.5 rounded-md border border-[var(--color-earthy-sage)]/45 bg-[var(--color-earthy-bg)] text-[8px] font-bold uppercase tracking-wider",n="rounded-md border border-[var(--color-earthy-sage)]/45 bg-[var(--color-earthy-bg)]/95",[i,s]=$(ln),[o,l]=$(!1),c=()=>{const p=typeof window<"u"?window.innerHeight-200:Ft;return Math.max(er,Math.min(t.maxHeight??Ft,p,Ft))},u=p=>Math.min(c(),Math.max(er,p)),f=()=>u(t.height??i()),d=p=>{const R=u(p);if(t.onHeightChange){t.onHeightChange(R);return}s(R)};let v=0,x=0,T=null;const w=p=>{p.preventDefault(),l(!0),T=p.pointerId,v=p.clientY,x=f(),document.body.style.cursor="row-resize",document.body.style.userSelect="none",window.addEventListener("pointermove",S),window.addEventListener("pointerup",M),window.addEventListener("pointercancel",M)},S=p=>{if(!o()||T!==null&&p.pointerId!==T)return;const R=v-p.clientY;d(x+R)},M=p=>{T!==null&&p.pointerId!==T||(l(!1),T=null,document.body.style.cursor="",document.body.style.userSelect="",window.removeEventListener("pointermove",S),window.removeEventListener("pointerup",M),window.removeEventListener("pointercancel",M))};bt(()=>{T=null,document.body.style.cursor="",document.body.style.userSelect="",window.removeEventListener("pointermove",S),window.removeEventListener("pointerup",M),window.removeEventListener("pointercancel",M)});const k=Re(()=>{const p=a.rtfxAverage();return p===0?"text-[var(--color-earthy-soft-brown)]":p>=2?"text-[var(--color-earthy-muted-green)] font-bold":(p>=1,"text-[var(--color-earthy-coral)] font-bold")});return(()=>{var p=ki(),R=p.firstChild,A=R.firstChild,H=R.nextSibling,W=H.firstChild,D=W.firstChild,P=D.firstChild,N=P.nextSibling;N.firstChild;var G=N.nextSibling,Y=D.nextSibling,_=Y.firstChild,h=_.firstChild,g=h.nextSibling,b=g.firstChild,C=_.nextSibling,E=C.firstChild,I=Y.nextSibling,F=I.firstChild,Z=F.firstChild,z=Z.nextSibling,te=F.nextSibling,re=te.firstChild,ae=re.nextSibling,ve=ae.firstChild,he=te.nextSibling,ue=he.firstChild,X=ue.nextSibling,be=I.nextSibling,J=be.firstChild,Te=J.firstChild,_e=Te.nextSibling,et=_e.firstChild,qe=J.nextSibling,De=qe.firstChild,ye=De.nextSibling,Qe=be.nextSibling,Oe=Qe.firstChild,Ye=Oe.firstChild,Fe=Ye.nextSibling,Mt=Fe.firstChild,Et=Oe.nextSibling,tt=Et.firstChild,St=tt.nextSibling,kt=W.nextSibling,xt=kt.firstChild,y=xt.firstChild,V=y.firstChild,ne=V.firstChild,Se=ne.firstChild,U=Se.nextSibling,fe=U.firstChild,ge=ne.nextSibling,ce=ge.firstChild,se=ce.nextSibling,Me=se.firstChild,j=ge.nextSibling,ze=j.firstChild,ke=ze.nextSibling,Pe=ke.firstChild,Ze=j.nextSibling,xe=Ze.firstChild,Be=xe.nextSibling,rt=Ze.nextSibling,nt=rt.firstChild,Ee=nt.nextSibling,Ne=Ee.firstChild,it=rt.nextSibling,dt=it.firstChild,wt=dt.nextSibling,q=it.nextSibling,Ke=q.firstChild,We=Ke.nextSibling,st=We.firstChild,Ue=y.nextSibling,ht=Ue.firstChild;return R.$$pointerdown=w,m(N,()=>a.backend(),null),m(G,()=>e()?"Recording":"Idle"),m(g,()=>(a.bufferMetrics().fillRatio*100).toFixed(0),b),m(z,()=>a.v4MergerStats().sentencesFinalized),m(ae,()=>a.matureCursorTime().toFixed(1),ve),m(X,()=>a.v4MergerStats().utterancesProcessed),m(_e,()=>(a.audioLevel()*100).toFixed(1),et),m(Fe,()=>(a.vadState().sileroProbability*100).toFixed(0),Mt),m(U,()=>a.v4InferenceIntervalMs(),fe),m(se,()=>a.v4SilenceFlushSec().toFixed(1),Me),m(ke,()=>(a.sileroThreshold()*100).toFixed(0),Pe),m(Be,(()=>{var B=Ge(()=>a.rtfxAverage()>0);return()=>B()?Math.round(a.rtfxAverage()):""})()),m(Ee,()=>Math.round(a.inferenceLatencyAverage()),Ne),m(wt,()=>a.vadState().hybridState),m(We,()=>a.vadState().snr.toFixed(1),st),m(Ue,O(Wn,{get audioEngine(){return t.audioEngine},get melClient(){return t.melClient},height:138,windowDuration:8}),ht),Q(B=>{var ut=`${f()}px`,ft=`relative z-10 h-2.5 w-10 rounded-full border shadow-sm transition-colors ${o()?"bg-[var(--color-earthy-sage)] border-[var(--color-earthy-muted-green)]/80":"bg-[var(--color-earthy-bg)] border-[var(--color-earthy-sage)]/60 group-hover:border-[var(--color-earthy-soft-brown)]/80"}`,gt=`${r} ${e()?"border-[var(--color-earthy-coral)] text-[var(--color-earthy-coral)] bg-[var(--color-earthy-coral)]/10":"text-[var(--color-earthy-soft-brown)]"}`,Nt=`${(a.bufferMetrics().fillRatio*100).toFixed(0)}%`,Vt=a.audioLevel()>a.energyThreshold()?"text-[var(--color-earthy-muted-green)]":"text-[var(--color-earthy-soft-brown)]",mt=`${a.energyThreshold()*100}%`,ir=`h-full transition-all duration-75 ${a.isSpeechDetected()?"bg-[var(--color-earthy-coral)]":"bg-[var(--color-earthy-muted-green)]"}`,sr=`${Math.min(100,a.audioLevel()*100)}%`,or=`space-y-1 transition-opacity duration-300 ${a.vadState().sileroProbability>0?"opacity-100":"opacity-40"}`,ar=a.vadState().sileroProbability>a.sileroThreshold()?"text-[var(--color-earthy-coral)] font-bold":"text-[var(--color-earthy-soft-brown)]",lr=`${a.sileroThreshold()*100}%`,cr=`h-full transition-all duration-75 ${a.vadState().sileroProbability>a.sileroThreshold()?"bg-[var(--color-earthy-coral)]":"bg-[var(--color-earthy-soft-brown)]"}`,dr=`${Math.min(100,a.vadState().sileroProbability*100)}%`,hr=`text-[10px] font-bold truncate ${k()}`,K=`text-[10px] font-bold whitespace-nowrap overflow-hidden text-ellipsis ${a.vadState().isSpeech?"text-[var(--color-earthy-coral)]":"text-[var(--color-earthy-soft-brown)]"}`,de=`${n} min-w-0 h-full p-1 transition-opacity duration-300 ${a.vadState().snr!==0?"opacity-100":"opacity-40"}`,Ie=`text-[10px] font-bold truncate ${a.vadState().snr>3?"text-[var(--color-earthy-muted-green)]":"text-[var(--color-earthy-soft-brown)]"}`;return ut!==B.e&&Le(p,"height",B.e=ut),ft!==B.t&&oe(A,B.t=ft),gt!==B.a&&oe(G,B.a=gt),Nt!==B.o&&Le(E,"width",B.o=Nt),Vt!==B.i&&oe(_e,B.i=Vt),mt!==B.n&&Le(De,"left",B.n=mt),ir!==B.s&&oe(ye,B.s=ir),sr!==B.h&&Le(ye,"width",B.h=sr),or!==B.r&&oe(Qe,B.r=or),ar!==B.d&&oe(Fe,B.d=ar),lr!==B.l&&Le(tt,"left",B.l=lr),cr!==B.u&&oe(St,B.u=cr),dr!==B.c&&Le(St,"width",B.c=dr),hr!==B.w&&oe(Be,B.w=hr),K!==B.m&&oe(wt,B.m=K),de!==B.f&&oe(q,B.f=de),Ie!==B.y&&oe(We,B.y=Ie),B},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0,r:void 0,d:void 0,l:void 0,u:void 0,c:void 0,w:void 0,m:void 0,f:void 0,y:void 0}),p})()};yt(["pointerdown"]);yt(["click","input"]);var Ii=L('<label class="flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium text-[var(--color-earthy-soft-brown)] hover:bg-[var(--color-earthy-sage)]/20 transition-colors cursor-pointer shrink-0"><span class="material-symbols-outlined text-lg">folder_open</span>Load from file<input type=file multiple class=hidden accept=.onnx,.bin>'),Ai=L('<div class=space-y-1><div class="flex justify-between text-xs"><span></span><span class="font-mono text-[var(--color-earthy-muted-green)]">%</span></div><div class="h-1.5 rounded-full overflow-hidden bg-[var(--color-earthy-sage)]/20"><div class="h-full bg-[var(--color-earthy-muted-green)] rounded-full transition-all duration-300">'),Di=L('<section class=space-y-2><h3 class="text-[10px] font-bold uppercase tracking-widest text-[var(--color-earthy-soft-brown)]">ASR model</h3><div class="flex items-center gap-2 flex-wrap"><select class="flex-1 min-w-0 text-sm bg-transparent border-b border-[var(--color-earthy-sage)]/40 px-0 py-1.5 text-[var(--color-earthy-dark-brown)] focus:outline-none focus:border-[var(--color-earthy-muted-green)]"></select><button type=button class="flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium text-[var(--color-earthy-muted-green)] hover:bg-[var(--color-earthy-sage)]/20 transition-colors disabled:opacity-50 disabled:cursor-not-allowed shrink-0"><span class="material-symbols-outlined text-lg">power_settings_new</span></button></div><p class="text-xs text-[var(--color-earthy-soft-brown)]"></p><div class="grid grid-cols-2 gap-x-4 gap-y-3 pt-1"><div class=space-y-1><span class="text-[10px] font-bold uppercase tracking-widest text-[var(--color-earthy-soft-brown)]">Backend</span><select class="w-full text-sm bg-transparent border-b border-[var(--color-earthy-sage)]/40 px-0 py-1.5 text-[var(--color-earthy-dark-brown)] focus:outline-none focus:border-[var(--color-earthy-muted-green)]"><option value=webgpu-hybrid>WebGPU</option><option value=wasm>WASM</option></select></div><div class=space-y-1><span class="text-[10px] font-bold uppercase tracking-widest text-[var(--color-earthy-soft-brown)]">Stride</span><input type=number min=1 max=4 step=1 class="w-full text-sm bg-transparent border-b border-[var(--color-earthy-sage)]/40 px-0 py-1.5 text-[var(--color-earthy-dark-brown)] focus:outline-none focus:border-[var(--color-earthy-muted-green)]"></div><div class=space-y-1><span class="text-[10px] font-bold uppercase tracking-widest text-[var(--color-earthy-soft-brown)]">Encoder</span><select class="w-full text-sm bg-transparent border-b border-[var(--color-earthy-sage)]/40 px-0 py-1.5 text-[var(--color-earthy-dark-brown)] focus:outline-none focus:border-[var(--color-earthy-muted-green)]"><option value=fp32>fp32</option><option value=int8>int8</option></select></div><div class=space-y-1><span class="text-[10px] font-bold uppercase tracking-widest text-[var(--color-earthy-soft-brown)]">Decoder</span><select class="w-full text-sm bg-transparent border-b border-[var(--color-earthy-sage)]/40 px-0 py-1.5 text-[var(--color-earthy-dark-brown)] focus:outline-none focus:border-[var(--color-earthy-muted-green)]"><option value=int8>int8</option><option value=fp32>fp32'),Fi=L('<section class=space-y-2><h3 class="text-[10px] font-bold uppercase tracking-widest text-[var(--color-earthy-soft-brown)]">Audio input</h3><select class="w-full text-sm bg-transparent border-b border-[var(--color-earthy-sage)]/40 px-0 py-1.5 text-[var(--color-earthy-dark-brown)] focus:outline-none focus:border-[var(--color-earthy-muted-green)]">'),Pi=L('<div class="space-y-1.5 min-w-0"><div class="flex justify-between items-center gap-2"><span class="text-[10px] font-bold uppercase tracking-widest text-[var(--color-earthy-soft-brown)]">VAD threshold</span><span class="text-sm text-[var(--color-earthy-dark-brown)] tabular-nums shrink-0">%</span></div><input type=range min=0.1 max=0.9 step=0.05 class="debug-slider w-full h-2 rounded-full appearance-none cursor-pointer bg-[var(--color-earthy-sage)]/30">'),Li=L('<div class="space-y-1.5 min-w-0"><div class="flex justify-between items-center gap-2"><span class="text-[10px] font-bold uppercase tracking-widest text-[var(--color-earthy-soft-brown)]">Tick interval</span><span class="text-sm text-[var(--color-earthy-dark-brown)] tabular-nums shrink-0"></span></div><input type=range min=160 max=8000 step=80 class="debug-slider w-full h-2 rounded-full appearance-none cursor-pointer bg-[var(--color-earthy-sage)]/30"><div class="flex justify-between text-[9px] text-[var(--color-earthy-soft-brown)]"><span>320ms</span><span>8.0s'),Bi=L('<div class="space-y-1.5 min-w-0"><div class="flex justify-between items-center gap-2"><span class="text-[10px] font-bold uppercase tracking-widest text-[var(--color-earthy-soft-brown)]">Silence flush</span><span class="text-sm text-[var(--color-earthy-dark-brown)] tabular-nums shrink-0">s</span></div><input type=range min=0.3 max=5.0 step=0.1 class="debug-slider w-full h-2 rounded-full appearance-none cursor-pointer bg-[var(--color-earthy-sage)]/30">'),Ni=L('<div class="space-y-1.5 min-w-0"><div class="flex justify-between items-center gap-2"><span class="text-[10px] font-bold uppercase tracking-widest text-[var(--color-earthy-soft-brown)]">Window</span><span class="text-sm text-[var(--color-earthy-dark-brown)] tabular-nums shrink-0">s</span></div><input type=range min=2.0 max=15.0 step=0.5 class="debug-slider w-full h-2 rounded-full appearance-none cursor-pointer bg-[var(--color-earthy-sage)]/30">'),Vi=L('<section class="grid grid-cols-2 gap-x-4 gap-y-3"><div class="space-y-1.5 min-w-0"><div class="flex justify-between items-center gap-2"><span class="text-[10px] font-bold uppercase tracking-widest text-[var(--color-earthy-soft-brown)]">WASM threads</span><span class="text-sm text-[var(--color-earthy-dark-brown)] tabular-nums shrink-0"> / </span></div><input type=range min=1 step=1 class="debug-slider w-full h-2 rounded-full appearance-none cursor-pointer bg-[var(--color-earthy-sage)]/30"><div class="text-[9px] text-[var(--color-earthy-soft-brown)]">Applied on next model load/reload.</div></div><div class="space-y-1.5 min-w-0"><div class="flex justify-between items-center gap-2"><span class="text-[10px] font-bold uppercase tracking-widest text-[var(--color-earthy-soft-brown)]">Energy threshold</span><span class="text-sm text-[var(--color-earthy-dark-brown)] tabular-nums shrink-0">%</span></div><input type=range min=0.005 max=0.3 step=0.005 class="debug-slider w-full h-2 rounded-full appearance-none cursor-pointer bg-[var(--color-earthy-sage)]/30">'),Oi=L('<div class=pt-2><button type=button class="flex items-center gap-2 px-0 py-2 text-sm font-medium text-[var(--color-earthy-muted-green)] hover:opacity-80 transition-opacity w-full"><span class="material-symbols-outlined text-lg">bug_report</span>Open Debug panel'),zi=L('<div class="flex flex-col min-h-0"><div class="flex flex-col flex-1 min-h-0 overflow-y-auto p-3 gap-4 custom-scrollbar">'),jr=L("<option>");const Wi=t=>t>=1e3?`${(t/1e3).toFixed(1)}s`:`${t}ms`,Ui=t=>{const e=()=>a.transcriptionMode()==="v4-utterance",r=()=>a.transcriptionMode()==="v3-streaming",n=()=>Ar(),i=()=>t.expandUp?.()??!1,s=()=>t.section??"full",o=()=>s()==="full"||s()==="model",l=()=>s()==="full"||s()==="audio",c=()=>s()==="full",u=()=>s()==="full";return(()=>{var f=zi(),d=f.firstChild;return m(d,O(ie,{get when(){return o()},get children(){var v=Di(),x=v.firstChild,T=x.nextSibling,w=T.firstChild,S=w.nextSibling;S.firstChild;var M=T.nextSibling,k=M.nextSibling,p=k.firstChild,R=p.firstChild,A=R.nextSibling,H=p.nextSibling,W=H.firstChild,D=W.nextSibling,P=H.nextSibling,N=P.firstChild,G=N.nextSibling,Y=P.nextSibling,_=Y.firstChild,h=_.nextSibling;return w.$$input=g=>a.setSelectedModelId(g.target.value),m(w,O(Xt,{each:nr,children:g=>(()=>{var b=jr();return m(b,()=>g.name),Q(()=>b.value=g.id),b})()})),sn(S,"click",t.onLoadModel),m(S,(()=>{var g=Ge(()=>a.modelState()==="ready");return()=>g()?"Reload":a.modelState()==="loading"?"...":"Load"})(),null),m(T,O(ie,{get when(){return t.onLocalLoad},get children(){var g=Ii(),b=g.firstChild,C=b.nextSibling,E=C.nextSibling;return E.addEventListener("change",I=>{const F=I.currentTarget.files;F&&F.length>0&&t.onLocalLoad?.(F),I.currentTarget.value=""}),g}}),null),m(M,(()=>{var g=Ge(()=>a.modelState()==="ready");return()=>g()?un(a.selectedModelId()):a.modelState()})()),A.$$input=g=>a.setModelBackendMode(g.target.value),D.$$input=g=>{const b=Number(g.target.value);Number.isFinite(b)&&a.setFrameStride(Math.max(1,Math.min(4,Math.round(b))))},G.$$input=g=>a.setEncoderQuant(g.target.value),h.$$input=g=>a.setDecoderQuant(g.target.value),m(v,O(ie,{get when(){return a.modelState()==="loading"},get children(){var g=Ai(),b=g.firstChild,C=b.firstChild,E=C.nextSibling,I=E.firstChild,F=b.nextSibling,Z=F.firstChild;return m(C,()=>a.modelMessage()),m(E,()=>Math.round(a.modelProgress()),I),Q(z=>Le(Z,"width",`${Math.max(0,Math.min(100,a.modelProgress()))}%`)),g}}),null),Q(g=>{var b=a.modelState()==="loading",C=a.modelState()==="loading",E=a.modelState()==="loading",I=a.modelState()==="loading",F=a.modelState()==="loading";return b!==g.e&&(w.disabled=g.e=b),C!==g.t&&(S.disabled=g.t=C),E!==g.a&&(A.disabled=g.a=E),I!==g.o&&(G.disabled=g.o=I),F!==g.i&&(h.disabled=g.i=F),g},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),Q(()=>w.value=a.selectedModelId()),Q(()=>A.value=a.modelBackendMode()),Q(()=>D.value=a.frameStride()),Q(()=>G.value=a.encoderQuant()),Q(()=>h.value=a.decoderQuant()),v}}),null),m(d,O(ie,{get when(){return l()},get children(){var v=Fi(),x=v.firstChild,T=x.nextSibling;return T.$$input=w=>{const S=w.target.value;a.setSelectedDeviceId(S),t.onDeviceSelect?.(S)},m(T,O(Xt,{get each(){return a.availableDevices()},children:w=>(()=>{var S=jr();return m(S,()=>w.label||`Device ${w.deviceId.slice(0,8)}`),Q(()=>S.value=w.deviceId),S})()})),Q(()=>T.value=a.selectedDeviceId()),v}}),null),m(d,O(ie,{get when(){return c()},get children(){var v=Vi(),x=v.firstChild,T=x.firstChild,w=T.firstChild,S=w.nextSibling,M=S.firstChild,k=T.nextSibling,p=x.nextSibling,R=p.firstChild,A=R.firstChild,H=A.nextSibling,W=H.firstChild,D=R.nextSibling;return m(S,()=>a.wasmThreads(),M),m(S,n,null),k.$$input=P=>{const N=parseInt(P.currentTarget.value,10);a.setWasmThreads(Math.max(1,Math.min(n(),N)))},m(H,()=>(a.energyThreshold()*100).toFixed(1),W),D.$$input=P=>{const N=parseFloat(P.currentTarget.value);a.setEnergyThreshold(N),t.audioEngine?.updateConfig({energyThreshold:N})},m(v,O(ie,{get when(){return e()},get children(){return[(()=>{var P=Pi(),N=P.firstChild,G=N.firstChild,Y=G.nextSibling,_=Y.firstChild,h=N.nextSibling;return m(Y,()=>(a.sileroThreshold()*100).toFixed(0),_),h.$$input=g=>a.setSileroThreshold(parseFloat(g.currentTarget.value)),Q(()=>h.value=a.sileroThreshold()),P})(),(()=>{var P=Li(),N=P.firstChild,G=N.firstChild,Y=G.nextSibling,_=N.nextSibling;return m(Y,()=>Wi(a.v4InferenceIntervalMs())),_.$$input=h=>a.setV4InferenceIntervalMs(parseInt(h.currentTarget.value)),Q(()=>_.value=a.v4InferenceIntervalMs()),P})(),(()=>{var P=Bi(),N=P.firstChild,G=N.firstChild,Y=G.nextSibling,_=Y.firstChild,h=N.nextSibling;return m(Y,()=>a.v4SilenceFlushSec().toFixed(1),_),h.$$input=g=>a.setV4SilenceFlushSec(parseFloat(g.currentTarget.value)),Q(()=>h.value=a.v4SilenceFlushSec()),P})()]}}),null),m(v,O(ie,{get when(){return r()},get children(){var P=Ni(),N=P.firstChild,G=N.firstChild,Y=G.nextSibling,_=Y.firstChild,h=N.nextSibling;return m(Y,()=>a.streamingWindow().toFixed(1),_),h.$$input=g=>a.setStreamingWindow(parseFloat(g.currentTarget.value)),Q(()=>h.value=a.streamingWindow()),P}}),null),Q(()=>Lt(k,"max",n())),Q(()=>k.value=Math.min(a.wasmThreads(),n())),Q(()=>D.value=a.energyThreshold()),v}}),null),m(d,O(ie,{get when(){return u()},get children(){var v=Oi(),x=v.firstChild;return x.$$click=()=>{t.onOpenDebug(),t.onClose()},v}}),null),Q(()=>d.classList.toggle("flex-col-reverse",!!i())),f})()};yt(["input","click"]);class Gr{sampleRate;maxFrames;buffer;currentFrame=0;constructor(e,r){this.sampleRate=e,this.maxFrames=Math.floor(e*r),this.buffer=new Float32Array(this.maxFrames)}write(e){let r=e.length,n=e;if(r>this.maxFrames){const o=r-this.maxFrames;n=e.subarray(o),this.currentFrame+=o,r=this.maxFrames}const i=this.currentFrame%this.maxFrames,s=this.maxFrames-i;r<=s?this.buffer.set(n,i):(this.buffer.set(n.subarray(0,s),i),this.buffer.set(n.subarray(s),0)),this.currentFrame+=r}read(e,r){if(e<0)throw new RangeError("startFrame must be non-negative");if(r<=e)return new Float32Array(0);const n=this.getBaseFrameOffset();if(e<n)throw new RangeError(`Requested frame ${e} has been overwritten. Oldest available: ${n}`);if(r>this.currentFrame)throw new RangeError(`Requested frame ${r} is in the future. Latest available: ${this.currentFrame}`);const i=r-e,s=new Float32Array(i),o=e%this.maxFrames,l=this.maxFrames-o;return i<=l?s.set(this.buffer.subarray(o,o+i)):(s.set(this.buffer.subarray(o,this.maxFrames)),s.set(this.buffer.subarray(0,i-l),l)),s}readInto(e,r,n){if(e<0)throw new RangeError("startFrame must be non-negative");if(r<=e)return 0;const i=this.getBaseFrameOffset();if(e<i)throw new RangeError(`Requested frame ${e} has been overwritten. Oldest available: ${i}`);if(r>this.currentFrame)throw new RangeError(`Requested frame ${r} is in the future. Latest available: ${this.currentFrame}`);const s=r-e,o=e%this.maxFrames,l=this.maxFrames-o;return s<=l?n.set(this.buffer.subarray(o,o+s)):(n.set(this.buffer.subarray(o,this.maxFrames)),n.set(this.buffer.subarray(0,s-l),l)),s}getCurrentFrame(){return this.currentFrame}getFillCount(){return Math.min(this.currentFrame,this.maxFrames)}getSize(){return this.maxFrames}getCurrentTime(){return this.currentFrame/this.sampleRate}getBaseFrameOffset(){return Math.max(0,this.currentFrame-this.maxFrames)}reset(){this.currentFrame=0,this.buffer.fill(0)}}const fn={medium:{audioThreshold:.08,silenceLength:.4}},Hi=fn.medium.audioThreshold,ji=fn.medium.silenceLength,Gi=.24,qi=.16,Qi=.24,Yi=.08,Zi=.12,Ki=.08,Xi=3,Ji=1,es=.05,ts=.15,rs=1,ns=.08,is=6,ss=3,os=20,as=4.8,ls=16e3,Ce={audioThreshold:Hi,silenceLength:ji,minSpeechDuration:Gi,maxSilenceWithinSpeech:qi,endingSpeechTolerance:Qi,lookbackDuration:Zi,overlapDuration:Ki,snrThreshold:Xi,minSnrThreshold:Ji,noiseFloorAdaptationRate:es,fastAdaptationRate:ts,minBackgroundDuration:rs,energyRiseThreshold:ns,smaLength:is,lookbackChunks:ss,maxHistoryLength:os,maxSegmentDuration:as,sampleRate:ls};class qr{options;state;constructor(e={}){const r=e.sampleRate??Ce.sampleRate??16e3;this.options={sampleRate:r,minSpeechDuration:Ce.minSpeechDuration,silenceThreshold:Ce.silenceLength,energyThreshold:Ce.audioThreshold,smaLength:Ce.smaLength,lookbackChunks:Ce.lookbackChunks,overlapDuration:Ce.overlapDuration,lookbackDuration:Ce.lookbackDuration,maxHistoryLength:Ce.maxHistoryLength,noiseFloorAdaptationRate:Ce.noiseFloorAdaptationRate,fastAdaptationRate:Ce.fastAdaptationRate,snrThreshold:Ce.snrThreshold,minBackgroundDuration:Ce.minBackgroundDuration,minSnrThreshold:Ce.minSnrThreshold,energyRiseThreshold:Ce.energyRiseThreshold,maxSegmentDuration:Ce.maxSegmentDuration,maxSilenceWithinSpeech:Ce.maxSilenceWithinSpeech,endingSpeechTolerance:Ce.endingSpeechTolerance,logger:console.log,...e,windowSize:Math.round(Yi*(e.sampleRate??r))},this.log("Initialized AudioSegmentProcessor",{sampleRate:this.options.sampleRate,windowSize:this.options.windowSize,lookbackDuration:this.options.lookbackDuration,overlapDuration:this.options.overlapDuration,snrThreshold:this.options.snrThreshold,minSnrThreshold:this.options.minSnrThreshold}),this.reset()}log(e,r){typeof this.options.logger=="function"&&this.options.logger(`[AudioSegmentProcessor] ${e}`,r)}processAudioData(e,r,n){if(!e||!e.length)return[];const i=[],s=n>this.options.energyThreshold;if(s)this.state.silenceDuration=0;else{const l=e.length/this.options.sampleRate;this.state.silenceDuration+=l}this.updateNoiseFloor(n,s);const o=this.calculateSNR(n);if(this.state.recentChunks.push({time:r,energy:n,isSpeech:s,snr:o}),this.state.recentChunks.length>this.options.maxHistoryLength*10&&this.state.recentChunks.shift(),this.state.inSpeech&&this.state.speechStartTime!==null){const l=r-this.state.speechStartTime;if(l>this.options.maxSegmentDuration){this.log("Splitting long segment",{startTime:this.state.speechStartTime.toFixed(2),splitTime:r.toFixed(2),duration:l.toFixed(2)});const c=this.createSegment(this.state.speechStartTime,r);c&&i.push(c),this.startSpeech(r,n)}}if(!this.state.inSpeech&&s){const l=this.findSpeechStart(),c=l!==-1?this.state.recentChunks[l].time:r;this.startSpeech(c,n),this.log("Speech start detected",{detectedAt:r.toFixed(2),actualStart:c.toFixed(2),lookbackDiff:(r-c).toFixed(2),snr:o.toFixed(2),noiseFloor:this.state.noiseFloor.toFixed(6)})}else if(this.state.inSpeech&&!s){this.state.silenceCounter++;const l=Math.ceil(this.options.silenceThreshold/(this.options.windowSize/this.options.sampleRate));this.state.silenceCounter%5===0&&this.log("Silence progressing",{counter:this.state.silenceCounter,needed:l,energy:n.toFixed(6),snr:o.toFixed(2)});const c=this.state.silenceCounter*(this.options.windowSize/this.options.sampleRate),u=this.state.silenceCounter>=l;if(c<this.options.maxSilenceWithinSpeech)this.state.speechEnergies.push(n);else if(u){if(this.state.speechStartTime!==null){const d=r-this.state.speechStartTime,v=this.state.speechEnergies.length>0?this.state.speechEnergies.reduce((x,T)=>x+T,0)/this.state.speechEnergies.length:0;this.recordSpeechStat({startTime:this.state.speechStartTime,endTime:r,duration:d,avgEnergy:v,energyIntegral:v*d})}const f=this.createSegment(this.state.speechStartTime,r);f&&i.push(f),this.startSilence(r)}else this.state.silenceEnergies.push(n)}else this.state.inSpeech?this.state.speechEnergies.push(n):this.state.silenceEnergies.push(n);return this.updateStats(),i}updateNoiseFloor(e,r){if(!r){let n=this.options.noiseFloorAdaptationRate;if(this.state.silenceDuration<this.options.minBackgroundDuration){const i=Math.min(1,this.state.silenceDuration/this.options.minBackgroundDuration);n=this.options.fastAdaptationRate*(1-i)+this.options.noiseFloorAdaptationRate*i}this.state.noiseFloor=this.state.noiseFloor*(1-n)+e*n,this.state.noiseFloor=Math.max(1e-5,this.state.noiseFloor)}this.state.recentEnergies.push(e),this.state.recentEnergies.length>50&&this.state.recentEnergies.shift()}calculateSNR(e){const r=Math.max(1e-4,this.state.noiseFloor);return 10*Math.log10(e/r)}startSpeech(e,r){this.state.inSpeech=!0,this.state.speechStartTime=e,this.state.silenceCounter=0,this.state.speechEnergies=[r],this.state.silenceStartTime=null,this.state.silenceDuration=0;const n=this.calculateSNR(r);this.log("Speech state started",{time:e.toFixed(2),energy:r.toFixed(6),snr:n.toFixed(2),noiseFloor:this.state.noiseFloor.toFixed(6)})}startSilence(e){this.state.inSpeech=!1,this.state.silenceStartTime=e,this.state.speechStartTime=null,this.state.silenceCounter=0,this.state.silenceEnergies=[],this.state.silenceDuration=.001,this.log("Silence state started",{time:e.toFixed(2),noiseFloor:this.state.noiseFloor.toFixed(6)})}findSpeechStart(){const e=this.state.recentChunks,r=this.options.minSnrThreshold;let n=0;for(let o=e.length-1;o>=0;o--)if(e[o].isSpeech){n=o;break}let i=n,s=!1;for(let o=n-1;o>=0&&(o<e.length-1&&e[o+1].energy>e[o].energy*(1+this.options.energyRiseThreshold)&&(i=o,s=!0),!(e[o].snr<r/2||n-o>6));o--);if(s)return this.log("Found rising energy trend for speech onset",{index:i,time:e[i].time.toFixed(3),energy:e[i].energy.toFixed(6),snr:e[i].snr.toFixed(2)}),i;for(let o=n;o>=0;o--)if(e[o].snr<r)return Math.min(e.length-1,o+1);return Math.max(0,n-4)}createSegment(e,r){const n=r-e;return n<=0?(this.log("Skipping segment with zero/negative duration"),null):{startTime:e,endTime:r,duration:n}}updateStats(){const e={silence:{avgDuration:0,avgEnergy:0,avgEnergyIntegral:0},speech:{avgDuration:0,avgEnergy:0,avgEnergyIntegral:0},noiseFloor:this.state.noiseFloor,snr:this.state.recentChunks.length>0?this.state.recentChunks[this.state.recentChunks.length-1].snr:0,snrThreshold:this.options.snrThreshold,minSnrThreshold:this.options.minSnrThreshold,energyRiseThreshold:this.options.energyRiseThreshold};if(this.state.silenceStats.length>0&&(e.silence=this.summarizeSegmentStats(this.state.silenceStats)),this.state.cachedSpeechSummary!==null)e.speech={...this.state.cachedSpeechSummary};else if(this.state.speechStats.length>0){const r=this.summarizeSegmentStats(this.state.speechStats);this.state.cachedSpeechSummary=r,e.speech={...r}}this.state.currentStats=e}recordSpeechStat(e){this.state.speechStats.push(e),this.state.speechStats.length>this.options.maxHistoryLength&&this.state.speechStats.shift(),this.state.cachedSpeechSummary=null}summarizeSegmentStats(e){if(e.length===0)return{avgDuration:0,avgEnergy:0,avgEnergyIntegral:0};let r=0,n=0,i=0;for(const o of e)r+=o.duration,n+=o.avgEnergy,i+=o.energyIntegral;const s=e.length;return{avgDuration:r/s,avgEnergy:n/s,avgEnergyIntegral:i/s}}getStats(){const e=this.state.currentStats;return{...e,silence:{...e.silence},speech:{...e.speech}}}getStateInfo(){return{inSpeech:this.state.inSpeech,noiseFloor:this.state.noiseFloor,snr:this.state.currentStats.snr,speechStartTime:this.state.speechStartTime}}reset(){this.state={inSpeech:!1,speechStartTime:null,silenceStartTime:null,silenceCounter:0,recentChunks:[],speechEnergies:[],silenceEnergies:[],speechStats:[],silenceStats:[],cachedSpeechSummary:null,currentStats:{silence:{avgDuration:0,avgEnergy:0,avgEnergyIntegral:0},speech:{avgDuration:0,avgEnergy:0,avgEnergyIntegral:0},noiseFloor:.005,snr:0,snrThreshold:this.options.snrThreshold,minSnrThreshold:this.options.minSnrThreshold,energyRiseThreshold:this.options.energyRiseThreshold},noiseFloor:.005,recentEnergies:[],silenceDuration:0}}setThreshold(e){this.options.energyThreshold=e,this.log("Updated energy threshold",e)}setSilenceLength(e){this.options.silenceThreshold=e,this.log("Updated silence threshold",e)}setLookbackDuration(e){this.options.lookbackDuration=e,this.log("Updated lookback duration",e)}setOverlapDuration(e){this.options.overlapDuration=e,this.log("Updated overlap duration",e)}setSnrThreshold(e){this.options.snrThreshold=e,this.log("Updated SNR threshold",e)}setMinSnrThreshold(e){this.options.minSnrThreshold=e,this.log("Updated minimum SNR threshold",e)}setNoiseFloorAdaptationRate(e){this.options.noiseFloorAdaptationRate=e,this.log("Updated noise floor adaptation rate",e)}setFastAdaptationRate(e){this.options.fastAdaptationRate=e,this.log("Updated fast adaptation rate",e)}setEnergyRiseThreshold(e){this.options.energyRiseThreshold=e,this.log("Updated energy rise threshold",e)}setMinBackgroundDuration(e){this.options.minBackgroundDuration=e,this.log("Updated minimum background duration",e)}setMaxSegmentDuration(e){this.options.maxSegmentDuration=e,this.log("Updated maximum segment duration",e)}setMinSpeechDuration(e){this.options.minSpeechDuration=e,this.log("Updated minimum speech duration",e)}setMaxSilenceWithinSpeech(e){this.options.maxSilenceWithinSpeech=e,this.log("Updated max silence within speech",e)}setEndingSpeechTolerance(e){this.options.endingSpeechTolerance=e,this.log("Updated ending speech tolerance",e)}}function cs(t,e,r){if(e===r)return t;const n=e/r,i=Math.floor(t.length/n),s=new Float32Array(i);for(let o=0;o<i;o++){const l=o*n,c=Math.floor(l),u=Math.min(c+1,t.length-1),f=l-c;s[o]=t[c]*(1-f)+t[u]*f}return s}const Qr=30;class ds{config;ringBuffer;audioProcessor;deviceId=null;audioContext=null;mediaStream=null;workletNode=null;sourceNode=null;analyserNode=null;analyserSourceNode=null;analyserGainNode=null;analyserTimeBuffer=null;waveformOut=null;ANALYSER_FFT_SIZE=256;ANALYSER_SMOOTHING=.3;deviceSampleRate=48e3;targetSampleRate=16e3;currentEnergy=0;segmentCallbacks=[];windowCallbacks=[];audioChunkCallbacks=[];energyHistory=[];energyBarHistory=[];BAR_LEVELS_SIZE=64;visualizationSummary=null;visualizationSummaryPosition=0;VIS_SUMMARY_SIZE=2e3;visualizationNotifyBuffer=null;metrics={currentEnergy:0,averageEnergy:0,peakEnergy:0,noiseFloor:.01,currentSNR:0,isSpeaking:!1};visualizationCallbacks=[];lastVisualizationNotifyTime=0;VISUALIZATION_NOTIFY_INTERVAL_MS=33;VISUALIZATION_NOTIFY_HIDDEN_INTERVAL_MS=250;HOT_PATH_DEBUG_LOGS=!1;recentSegments=[];MAX_SEGMENTS_FOR_VISUALIZATION=50;constructor(e={}){this.config={sampleRate:16e3,bufferDuration:120,energyThreshold:.08,minSpeechDuration:240,minSilenceDuration:400,maxSegmentDuration:4.8,lookbackDuration:.12,speechHangover:.16,minEnergyIntegral:22,minEnergyPerSecond:5,useAdaptiveEnergyThresholds:!0,adaptiveEnergyIntegralFactor:25,adaptiveEnergyPerSecondFactor:10,minAdaptiveEnergyIntegral:3,minAdaptiveEnergyPerSecond:1,maxSilenceWithinSpeech:.16,endingSpeechTolerance:.24,...e},this.deviceId=this.config.deviceId||null,this.targetSampleRate=this.config.sampleRate,this.ringBuffer=new Gr(this.targetSampleRate,this.config.bufferDuration),this.audioProcessor=new qr({sampleRate:this.targetSampleRate,energyThreshold:this.config.energyThreshold,minSpeechDuration:this.config.minSpeechDuration,silenceThreshold:this.config.minSilenceDuration,maxSegmentDuration:this.config.maxSegmentDuration,lookbackDuration:this.config.lookbackDuration,maxSilenceWithinSpeech:this.config.maxSilenceWithinSpeech,endingSpeechTolerance:this.config.endingSpeechTolerance,snrThreshold:3,minSnrThreshold:1,noiseFloorAdaptationRate:.05,fastAdaptationRate:.15,minBackgroundDuration:1,energyRiseThreshold:.08}),this.visualizationSummary=new Float32Array(this.VIS_SUMMARY_SIZE*2),this.visualizationSummaryPosition=0,console.log("[AudioEngine] Initialized with config:",this.config)}isWorkletInitialized=!1;async init(){try{this.mediaStream&&this.mediaStream.getTracks().forEach(i=>i.stop());const n={audio:{deviceId:this.deviceId?{exact:this.deviceId}:void 0,channelCount:1,echoCancellation:!1,noiseSuppression:!1,autoGainControl:!1}};console.log("[AudioEngine] Requesting microphone:",n),this.mediaStream=await navigator.mediaDevices.getUserMedia(n),console.log("[AudioEngine] Microphone stream acquired:",this.mediaStream.id)}catch(n){throw console.error("[AudioEngine] Failed to get media stream:",n),n}const r=this.mediaStream.getAudioTracks()[0]?.getSettings?.();if(this.deviceSampleRate=r?.sampleRate??48e3,console.log("[AudioEngine] Device sample rate:",this.deviceSampleRate,"-> Target:",this.targetSampleRate),this.audioContext&&this.audioContext.sampleRate!==this.deviceSampleRate&&(await this.audioContext.close(),this.audioContext=null),this.audioContext||(this.audioContext=new AudioContext({sampleRate:this.deviceSampleRate,latencyHint:"interactive"}),console.log("[AudioEngine] Created AudioContext:",this.audioContext.state,"sampleRate:",this.audioContext.sampleRate)),this.ringBuffer=new Gr(this.targetSampleRate,this.config.bufferDuration),this.audioProcessor=new qr({sampleRate:this.targetSampleRate,energyThreshold:this.config.energyThreshold,minSpeechDuration:this.config.minSpeechDuration,silenceThreshold:this.config.minSilenceDuration,maxSegmentDuration:this.config.maxSegmentDuration}),!this.isWorkletInitialized){const i=`
                class CaptureProcessor extends AudioWorkletProcessor {
                    constructor(options) {
                        super(options);
                        const opts = options?.processorOptions || {};
                        this.inputSampleRate = opts.inputSampleRate || 16000;
                        this.targetSampleRate = opts.targetSampleRate || this.inputSampleRate;
                        this.ratio = this.inputSampleRate / this.targetSampleRate;
                        this.bufferSize = Math.round(${.08} * this.inputSampleRate);
                        this.buffer = new Float32Array(this.bufferSize);
                        this.index = 0;
                        this._lastLog = 0;
                    }

                    _emitChunk() {
                        let out;
                        let maxAbs = 0;

                        if (this.targetSampleRate === this.inputSampleRate) {
                            out = new Float32Array(this.bufferSize);
                            for (let i = 0; i < this.bufferSize; i++) {
                                const v = this.buffer[i];
                                out[i] = v;
                                const a = v < 0 ? -v : v;
                                if (a > maxAbs) maxAbs = a;
                            }
                        } else {
                            const outLength = Math.floor(this.bufferSize / this.ratio);
                            out = new Float32Array(outLength);
                            for (let i = 0; i < outLength; i++) {
                                const srcIndex = i * this.ratio;
                                const srcIndexFloor = Math.floor(srcIndex);
                                const srcIndexCeil = Math.min(srcIndexFloor + 1, this.bufferSize - 1);
                                const t = srcIndex - srcIndexFloor;
                                const v = this.buffer[srcIndexFloor] * (1 - t) + this.buffer[srcIndexCeil] * t;
                                out[i] = v;
                                const a = v < 0 ? -v : v;
                                if (a > maxAbs) maxAbs = a;
                            }
                        }

                        this.port.postMessage(
                            { type: 'audio', samples: out, sampleRate: this.targetSampleRate, maxAbs },
                            [out.buffer]
                        );
                    }

                    process(inputs) {
                        const input = inputs[0];
                        if (!input || !input[0]) return true;
                        
                        const channelData = input[0];
                        
                        // Buffer the data
                        for (let i = 0; i < channelData.length; i++) {
                            this.buffer[this.index++] = channelData[i];
                            
                            if (this.index >= this.bufferSize) {
                                this._emitChunk();
                                this.index = 0;
                                
                                // Debug log every ~5 seconds
                                const now = Date.now();
                                if (now - this._lastLog > 5000) {
                                    this.port.postMessage({ type: 'log', message: '[AudioWorklet] Active' });
                                    this._lastLog = now;
                                }
                            }
                        }
                        
                        return true;
                    }
                }
                registerProcessor('capture-processor', CaptureProcessor);
            `,s=new Blob([i],{type:"application/javascript"}),o=URL.createObjectURL(s);try{await this.audioContext.audioWorklet.addModule(o),this.isWorkletInitialized=!0,console.log("[AudioEngine] AudioWorklet module loaded")}catch(l){console.error("[AudioEngine] Failed to load worklet:",l),l instanceof Error&&l.name==="InvalidStateError"&&(this.isWorkletInitialized=!0)}}this.workletNode&&this.workletNode.disconnect(),this.workletNode=new AudioWorkletNode(this.audioContext,"capture-processor",{processorOptions:{inputSampleRate:this.deviceSampleRate,targetSampleRate:this.targetSampleRate}}),this.workletNode.port.onmessage=n=>{n.data?.type==="audio"&&n.data.samples instanceof Float32Array?this.handleAudioChunk(n.data.samples,n.data.maxAbs,n.data.sampleRate):n.data instanceof Float32Array?this.handleAudioChunk(n.data,void 0,this.deviceSampleRate):n.data?.type==="log"&&console.log(n.data.message)},this.workletNode.onprocessorerror=n=>{console.error("[AudioEngine] Worklet processor error:",n)},this.sourceNode?.disconnect(),this.sourceNode=this.audioContext.createMediaStreamSource(this.mediaStream),this.sourceNode.connect(this.workletNode),this.disposeAnalyser(),this.analyserSourceNode=this.audioContext.createMediaStreamSource(this.mediaStream),this.analyserNode=this.audioContext.createAnalyser(),this.analyserNode.fftSize=this.ANALYSER_FFT_SIZE,this.analyserNode.smoothingTimeConstant=this.ANALYSER_SMOOTHING,this.analyserTimeBuffer=new Uint8Array(this.analyserNode.fftSize),this.waveformOut=new Float32Array(this.analyserNode.fftSize),this.analyserGainNode=this.audioContext.createGain(),this.analyserGainNode.gain.value=0,this.analyserSourceNode.connect(this.analyserNode),this.analyserNode.connect(this.analyserGainNode),this.analyserGainNode.connect(this.audioContext.destination),this.workletNode.connect(this.audioContext.destination),console.log("[AudioEngine] Graph connected: Source -> Worklet, AnalyserNode for oscilloscope")}async start(){(!this.mediaStream||!this.audioContext||!this.workletNode)&&await this.init(),this.audioContext?.state==="suspended"&&await this.audioContext.resume()}stop(){this.audioContext?.state==="running"&&this.audioContext.suspend()}reset(){this.ringBuffer.reset(),this.audioProcessor.reset(),this.currentEnergy=0,this.metrics={currentEnergy:0,averageEnergy:0,peakEnergy:0,noiseFloor:.01,currentSNR:0,isSpeaking:!1},this.recentSegments=[],this.energyBarHistory=[],this.visualizationSummary&&this.visualizationSummary.fill(0),this.visualizationSummaryPosition=0;for(const e of this.windowCallbacks)e.lastWindowEnd=0;this.notifyVisualizationUpdate()}getCurrentEnergy(){return this.currentEnergy}getBarLevels(){if(this.analyserNode&&this.analyserTimeBuffer&&this.waveformOut){this.analyserNode.getByteTimeDomainData(this.analyserTimeBuffer);for(let i=0;i<this.analyserTimeBuffer.length;i++)this.waveformOut[i]=(this.analyserTimeBuffer[i]-128)/128;return this.waveformOut}const e=new Float32Array(this.BAR_LEVELS_SIZE),r=this.energyBarHistory,n=r.length<=this.BAR_LEVELS_SIZE?0:r.length-this.BAR_LEVELS_SIZE;for(let i=0;i<this.BAR_LEVELS_SIZE;i++){const s=n+i;e[i]=s<r.length?Math.min(1,Math.max(0,r[s])):0}return e}getSignalMetrics(){const e=this.audioProcessor.getStats();return{noiseFloor:e.noiseFloor??1e-4,snr:e.snr??0,threshold:this.config.energyThreshold,snrThreshold:e.snrThreshold??3}}isSpeechActive(){return this.audioProcessor.getStateInfo().inSpeech}getRingBuffer(){return this.ringBuffer}onSpeechSegment(e){return this.segmentCallbacks.push(e),()=>{this.segmentCallbacks=this.segmentCallbacks.filter(r=>r!==e)}}onWindowChunk(e,r,n,i){const s={windowDuration:e,overlapDuration:r,triggerInterval:n,callback:i,lastWindowEnd:0};return this.windowCallbacks.push(s),()=>{this.windowCallbacks=this.windowCallbacks.filter(o=>o!==s)}}onAudioChunk(e){return this.audioChunkCallbacks.push(e),()=>{this.audioChunkCallbacks=this.audioChunkCallbacks.filter(r=>r!==e)}}updateConfig(e){this.config={...this.config,...e},e.energyThreshold!==void 0&&this.audioProcessor.setThreshold(e.energyThreshold),e.minSpeechDuration!==void 0&&this.audioProcessor.setMinSpeechDuration(e.minSpeechDuration),e.minSilenceDuration!==void 0&&this.audioProcessor.setSilenceLength(e.minSilenceDuration),e.maxSegmentDuration!==void 0&&this.audioProcessor.setMaxSegmentDuration(e.maxSegmentDuration),e.lookbackDuration!==void 0&&this.audioProcessor.setLookbackDuration(e.lookbackDuration),e.overlapDuration!==void 0&&this.audioProcessor.setOverlapDuration(e.overlapDuration),e.maxSilenceWithinSpeech!==void 0&&this.audioProcessor.setMaxSilenceWithinSpeech(e.maxSilenceWithinSpeech),e.endingSpeechTolerance!==void 0&&this.audioProcessor.setEndingSpeechTolerance(e.endingSpeechTolerance),e.snrThreshold!==void 0&&this.audioProcessor.setSnrThreshold(e.snrThreshold),e.minSnrThreshold!==void 0&&this.audioProcessor.setMinSnrThreshold(e.minSnrThreshold)}async setDevice(e){this.deviceId=e,await this.init(),this.audioContext&&this.workletNode&&(this.sourceNode?.disconnect(),this.sourceNode=this.audioContext.createMediaStreamSource(this.mediaStream),this.sourceNode.connect(this.workletNode))}disposeAnalyser(){this.analyserSourceNode?.disconnect(),this.analyserNode?.disconnect(),this.analyserGainNode?.disconnect(),this.analyserSourceNode=null,this.analyserNode=null,this.analyserGainNode=null,this.analyserTimeBuffer=null,this.waveformOut=null}dispose(){this.stop(),this.disposeAnalyser(),this.mediaStream?.getTracks().forEach(e=>e.stop()),this.audioContext?.close(),this.audioContext=null,this.mediaStream=null,this.workletNode=null,this.sourceNode=null}handleAudioChunk(e,r,n){const i=n??this.targetSampleRate,s=i!==this.targetSampleRate,o=s?cs(e,i,this.targetSampleRate):e;let l=!s&&r!==void 0?r:0;if(r===void 0||s)for(let S=0;S<o.length;S++){const M=Math.abs(o[S]);M>l&&(l=M)}this.energyHistory.push(l),this.energyHistory.length>6&&this.energyHistory.shift();const c=this.energyHistory.reduce((S,M)=>S+M,0)/this.energyHistory.length;this.currentEnergy=c,this.energyBarHistory.push(c),this.energyBarHistory.length>this.BAR_LEVELS_SIZE&&this.energyBarHistory.shift();const u=c>this.config.energyThreshold,f=this.metrics.isSpeaking;this.HOT_PATH_DEBUG_LOGS&&u!==f&&console.debug(`[AudioEngine] Energy threshold crossed: ${c.toFixed(6)} > ${this.config.energyThreshold} = ${u}`),this.ringBuffer.write(o);const d=this.ringBuffer.getCurrentFrame(),v=this.ringBuffer.getCurrentTime(),x=this.audioProcessor.processAudioData(o,v,c);this.updateVisualizationBuffer(o);const T=this.audioProcessor.getStats(),w=this.audioProcessor.getStateInfo();if(this.metrics.currentEnergy=c,this.metrics.averageEnergy=this.metrics.averageEnergy*.95+c*.05,this.metrics.peakEnergy=Math.max(this.metrics.peakEnergy*.99,c),this.metrics.noiseFloor=T.noiseFloor??.01,this.metrics.currentSNR=T.snr??0,this.metrics.isSpeaking=w.inSpeech,this.HOT_PATH_DEBUG_LOGS&&Math.random()<.05&&console.debug(`[AudioEngine] Metrics: E=${c.toFixed(6)}, NF=${this.metrics.noiseFloor.toFixed(6)}, SNR=${this.metrics.currentSNR.toFixed(2)}, Speaking=${this.metrics.isSpeaking}`),x.length>0)for(const S of x){const M=this.config.lookbackDuration??.12,k=Math.max(0,S.startTime-M),p=Math.round(k*this.targetSampleRate),R=Math.round(S.endTime*this.targetSampleRate),A=this.config.speechHangover??.16,H=Math.min(this.ringBuffer.getCurrentFrame(),R+Math.round(A*this.targetSampleRate));try{const W=this.ringBuffer.read(p,H),D=this.calculateSegmentEnergyMetrics(W,this.targetSampleRate),P=D.averagePower*16e3,N=P*D.duration;let G=this.config.minEnergyIntegral??22,Y=this.config.minEnergyPerSecond??5;if(this.config.useAdaptiveEnergyThresholds){const h=this.config.windowSize??Math.round(.08*this.targetSampleRate),b=(h>0?this.metrics.noiseFloor/h:0)*16e3,C=b*(this.config.adaptiveEnergyIntegralFactor??25);G=Math.max(this.config.minAdaptiveEnergyIntegral??3,C);const E=b*(this.config.adaptiveEnergyPerSecondFactor??10);Y=Math.max(this.config.minAdaptiveEnergyPerSecond??1,E)}if(D.duration>=this.config.minSpeechDuration/1e3&&P>=Y&&N>=G){const h={startFrame:p,endFrame:H,duration:D.duration,averageEnergy:D.averagePower,timestamp:Date.now()};this.notifySegment(h)}else this.HOT_PATH_DEBUG_LOGS&&console.log("[AudioEngine] Filtered out noise segment:",{duration:D.duration,power:P,integral:N})}catch(W){console.warn("[AudioEngine] Failed to extract audio for validation:",W)}}this.processWindowCallbacks(d);for(const S of this.audioChunkCallbacks)S(o);this.notifyVisualizationUpdate()}calculateSegmentEnergyMetrics(e,r){if(!e||e.length===0)return{averagePower:0,duration:0,numSamples:0};const n=e.length;let i=0;for(let l=0;l<n;l++)i+=e[l]*e[l];const s=n/r;return{averagePower:n>0?i/n:0,duration:s,numSamples:n}}processWindowCallbacks(e){for(const r of this.windowCallbacks){const n=Math.floor(r.windowDuration*this.targetSampleRate),i=Math.floor(r.triggerInterval*this.targetSampleRate);if(r.lastWindowEnd===0){r.lastWindowEnd=e;continue}if(e-r.lastWindowEnd>=i){const o=e,l=o-n,c=this.ringBuffer.getBaseFrameOffset();if(l>=c)try{const u=this.ringBuffer.read(l,o),f=l/this.targetSampleRate;r.callback(u,f),r.lastWindowEnd=o}catch(u){console.warn("[AudioEngine] Window read failed:",u)}}}}notifySegment(e){this.recentSegments.push({startTime:e.startFrame/this.targetSampleRate,endTime:e.endFrame/this.targetSampleRate,isProcessed:!1}),this.recentSegments.length>this.MAX_SEGMENTS_FOR_VISUALIZATION&&this.recentSegments.shift(),this.segmentCallbacks.forEach(r=>r(e))}getSegmentsForVisualization(){const e=[...this.recentSegments],r=this.audioProcessor.getStateInfo();return r.inSpeech&&r.speechStartTime!==null&&e.push({startTime:r.speechStartTime,endTime:this.ringBuffer.getCurrentTime(),isProcessed:!1}),e}markSegmentProcessed(e){const r=this.recentSegments.find(n=>Math.abs(n.startTime-e)<.1);r&&(r.isProcessed=!0)}updateVisualizationBuffer(e){if(!this.visualizationSummary)return;const r=e.length,i=Math.round(this.targetSampleRate*Qr)/this.VIS_SUMMARY_SIZE,s=Math.round(r/i);for(let o=0;o<s;o++){const l=Math.floor(o*i),c=Math.min(r,Math.floor((o+1)*i));if(l>=c)continue;let u=e[l],f=e[l];for(let v=l+1;v<c;v++){const x=e[v];x<u&&(u=x),x>f&&(f=x)}const d=this.visualizationSummaryPosition*2;this.visualizationSummary[d]=u,this.visualizationSummary[d+1]=f,this.visualizationSummaryPosition=(this.visualizationSummaryPosition+1)%this.VIS_SUMMARY_SIZE}}getVisualizationData(e,r){if(!this.visualizationSummary||!e||e<=0)return new Float32Array(0);const n=Math.min(e,this.VIS_SUMMARY_SIZE),i=n*2,s=r&&r.length===i?r:new Float32Array(i),o=this.VIS_SUMMARY_SIZE/n;for(let l=0;l<n;l++){const c=l*o,u=(l+1)*o;let f=0,d=0,v=!0;for(let x=Math.floor(c);x<Math.floor(u);x++){const T=(this.visualizationSummaryPosition+x)%this.VIS_SUMMARY_SIZE*2,w=this.visualizationSummary[T],S=this.visualizationSummary[T+1];v?(f=w,d=S,v=!1):(w<f&&(f=w),S>d&&(d=S))}s[l*2]=f,s[l*2+1]=d}return s}getMetrics(){return{...this.metrics}}getCurrentTime(){return this.ringBuffer.getCurrentTime()}getVisualizationDuration(){return Qr}onVisualizationUpdate(e){return this.visualizationCallbacks.push(e),()=>{this.visualizationCallbacks=this.visualizationCallbacks.filter(r=>r!==e)}}notifyVisualizationUpdate(){const e=performance.now(),r=typeof document<"u"&&document.visibilityState!=="visible"?this.VISUALIZATION_NOTIFY_HIDDEN_INTERVAL_MS:this.VISUALIZATION_NOTIFY_INTERVAL_MS;if(e-this.lastVisualizationNotifyTime<r)return;this.lastVisualizationNotifyTime=e;const n=400,i=n*2;(!this.visualizationNotifyBuffer||this.visualizationNotifyBuffer.length!==i)&&(this.visualizationNotifyBuffer=new Float32Array(i));const s=this.getVisualizationData(n,this.visualizationNotifyBuffer),o=this.ringBuffer.getCurrentTime();this.visualizationCallbacks.forEach(l=>l(s,this.getMetrics(),o))}}class Yr{worker;messageId=0;pendingPromises=new Map;initFailed=!1;constructor(){this.worker=new Worker(new URL("/keet/assets/mel.worker-BtRe9lDU.js",import.meta.url),{type:"module"}),this.worker.onmessage=e=>{this.handleMessage(e)},this.worker.onerror=e=>{const r=e,n=r.message||"Worker failed to load",i=r.filename?` at ${r.filename}:${r.lineno}:${r.colno}`:"";console.error(`[MelWorkerClient] Worker error: ${n}${i}`,e),this.initFailed=!0;for(const[,s]of this.pendingPromises)s.reject(new Error(`[MelWorkerClient] ${n}${i}`));this.pendingPromises.clear()}}async init(e={}){if(this.initFailed)throw new Error("[MelWorkerClient] Worker failed to load");await this.sendRequest("INIT",e)}pushAudio(e){this.initFailed||this.worker.postMessage({type:"PUSH_AUDIO",payload:e},[e.buffer])}pushAudioCopy(e){if(this.initFailed)return;const r=new Float32Array(e);this.worker.postMessage({type:"PUSH_AUDIO",payload:r},[r.buffer])}async getFeatures(e,r,n=!0){return this.sendRequest("GET_FEATURES",{startSample:e,endSample:r,normalize:n})}async getLastMelFrame(){const e=await this.sendRequest("GET_LAST_MEL_FRAME",{});return e&&e.melFrame?e.melFrame:null}async getStatus(){return this.sendRequest("GET_STATUS",{})}async reset(){return this.sendRequest("RESET",{})}dispose(){this.worker.terminate();for(const[,e]of this.pendingPromises)e.reject(new Error("MelWorkerClient disposed"));this.pendingPromises.clear()}handleMessage(e){const{type:r,payload:n,id:i}=e.data;if(r==="ERROR"){const s=this.pendingPromises.get(i);s&&(this.pendingPromises.delete(i),s.reject(new Error(n)));return}if(i!==void 0){const s=this.pendingPromises.get(i);s&&(this.pendingPromises.delete(i),s.resolve(n))}}sendRequest(e,r){return new Promise((n,i)=>{if(this.initFailed){i(new Error("MelWorkerClient: worker failed to load"));return}const s=++this.messageId;this.pendingPromises.set(s,{resolve:n,reject:i}),this.worker.postMessage({type:e,payload:r,id:s})})}}class hs{worker;messageId=0;pendingPromises=new Map;onModelProgress;onModelStateChange;onV3Confirmed;onV3Pending;onError;constructor(){this.worker=new Worker(new URL("/keet/assets/transcription.worker-DvFn4fmJ.js",import.meta.url),{type:"module"}),this.worker.onmessage=e=>this.handleMessage(e.data),this.worker.onerror=e=>{console.error("[TranscriptionWorkerClient] Fatal Worker Error:",e),this.onError?.("Fatal background worker error")}}handleMessage(e){const{type:r,payload:n,id:i}=e;if(i!==void 0&&this.pendingPromises.has(i)){const{resolve:s,reject:o}=this.pendingPromises.get(i);this.pendingPromises.delete(i),r==="ERROR"?o(new Error(n)):s(n);return}switch(r){case"MODEL_PROGRESS":this.onModelProgress?.(n);break;case"MODEL_STATE":this.onModelStateChange?.(n);break;case"V3_CONFIRMED":this.onV3Confirmed?.(n.text,n.words);break;case"V3_PENDING":this.onV3Pending?.(n.text,n.words);break;case"ERROR":this.onError?.(n);break}}sendRequest(e,r,n){const i=this.messageId++;return new Promise((s,o)=>{this.pendingPromises.set(i,{resolve:s,reject:o}),this.worker.postMessage({type:e,payload:r,id:i},n||[])})}transferList(e,r){return r===!1?[]:[e]}normalizeCpuThreads(e){if(Number.isFinite(e))return Math.max(1,Math.floor(e))}async initModel(e={}){return this.sendRequest("INIT_MODEL",{...e,cpuThreads:this.normalizeCpuThreads(e.cpuThreads)})}async initLocalModel(e,r={}){return this.sendRequest("LOAD_LOCAL_MODEL",{files:Array.from(e),cpuThreads:this.normalizeCpuThreads(r.cpuThreads),backend:r.backend})}async initService(e){return this.sendRequest("INIT_SERVICE",{config:e})}async initV3Service(e){return this.sendRequest("INIT_V3_SERVICE",{config:e})}async processChunk(e,r={}){return this.sendRequest("PROCESS_CHUNK",e,this.transferList(e.buffer,r.transferOwnership))}async processV3Chunk(e,r,n={}){return this.sendRequest("PROCESS_V3_CHUNK",{audio:e,startTime:r},this.transferList(e.buffer,n.transferOwnership))}async processV3ChunkWithFeatures(e,r,n,i,s,o={}){return this.sendRequest("PROCESS_V3_CHUNK_WITH_FEATURES",{features:e,T:r,melBins:n,startTime:i,overlapSeconds:s},this.transferList(e.buffer,o.transferOwnership))}async transcribeSegment(e,r={}){return this.sendRequest("TRANSCRIBE_SEGMENT",e,this.transferList(e.buffer,r.transferOwnership))}async reset(){return this.sendRequest("RESET")}async finalize(){return this.sendRequest("FINALIZE")}async initV4Service(e){return this.sendRequest("INIT_V4_SERVICE",{config:e||{}})}async processV4ChunkWithFeatures(e){const{transferOwnership:r,...n}=e;return this.sendRequest("PROCESS_V4_CHUNK_WITH_FEATURES",n,this.transferList(n.features.buffer,r))}async v4FinalizeTimeout(){return this.sendRequest("V4_FINALIZE_TIMEOUT")}async v4Reset(){return this.sendRequest("V4_RESET")}dispose(){this.worker.terminate(),this.pendingPromises.clear()}}class us{config;isSpeechActive=!1;speechConfirmationCounter=0;silenceConfirmationCounter=0;minSpeechFrames;minSilenceFrames;noiseFloor=.005;snr=0;silenceDuration=0;noiseFloorAdaptationRate=.05;fastAdaptationRate=.15;minBackgroundDuration=1;snrThreshold=3;constructor(e={}){this.config={energyThreshold:.02,minSpeechDuration:100,minSilenceDuration:300,sampleRate:16e3,...e},this.minSpeechFrames=Math.ceil(this.config.minSpeechDuration/1e3*this.config.sampleRate),this.minSilenceFrames=Math.ceil(this.config.minSilenceDuration/1e3*this.config.sampleRate)}process(e){let r=0;for(let x=0;x<e.length;x++)r+=e[x]*e[x];const n=Math.sqrt(r/e.length),i=Date.now(),s=e.length/this.config.sampleRate,o=Math.max(1e-4,this.noiseFloor);this.snr=10*Math.log10(n/o);const l=this.snr>this.snrThreshold,c=n>this.config.energyThreshold,u=l||c;if(u)this.silenceDuration=0;else{this.silenceDuration+=s;let x=this.noiseFloorAdaptationRate;if(this.silenceDuration<this.minBackgroundDuration){const T=Math.min(1,this.silenceDuration/this.minBackgroundDuration);x=this.fastAdaptationRate*(1-T)+this.noiseFloorAdaptationRate*T}this.noiseFloor=this.noiseFloor*(1-x)+n*x,this.noiseFloor=Math.max(1e-5,this.noiseFloor)}const f=e.length;let d=!1,v=!1;return u?(this.silenceConfirmationCounter=0,this.isSpeechActive||(this.speechConfirmationCounter+=f,this.speechConfirmationCounter>=this.minSpeechFrames&&(this.isSpeechActive=!0,d=!0))):(this.speechConfirmationCounter=0,this.isSpeechActive&&(this.silenceConfirmationCounter+=f,this.silenceConfirmationCounter>=this.minSilenceFrames&&(this.isSpeechActive=!1,v=!0,this.silenceConfirmationCounter=0))),{isSpeech:this.isSpeechActive,energy:n,timestamp:i,speechStart:d,speechEnd:v,noiseFloor:this.noiseFloor,snr:this.snr}}reset(){this.isSpeechActive=!1,this.speechConfirmationCounter=0,this.silenceConfirmationCounter=0,this.noiseFloor=.005,this.snr=0,this.silenceDuration=0}updateConfig(e){this.config={...this.config,...e},this.minSpeechFrames=Math.ceil(this.config.minSpeechDuration/1e3*this.config.sampleRate),this.minSilenceFrames=Math.ceil(this.config.minSilenceDuration/1e3*this.config.sampleRate)}getConfig(){return{...this.config}}}class fs{config;session=null;initialized=!1;stateH=null;stateC=null;srTensor=null;hopSize;contextSize;contextBuffer;constructor(e={}){this.config={modelUrl:"https://huggingface.co/onnx-community/silero-vad/resolve/main/onnx/model.onnx",threshold:.5,negThreshold:e.threshold!==void 0?e.threshold-.15:.35,sampleRate:16e3,...e},this.hopSize=this.config.sampleRate===16e3?512:256,this.contextSize=this.config.sampleRate===16e3?64:32,this.contextBuffer=new Float32Array(this.contextSize)}async init(e){if(this.initialized)return;const r=e||this.config.modelUrl,n=typeof ort<"u"?ort:globalThis.ort;if(!n)throw new Error("onnxruntime-web (ort) not found. Ensure parakeet.js backend is initialized first.");this.session=await n.InferenceSession.create(r,{executionProviders:["wasm"],graphOptimizationLevel:"all"}),this.stateH=new n.Tensor("float32",new Float32Array(256),[2,1,128]),this.srTensor=new n.Tensor("int64",BigInt64Array.from([BigInt(this.config.sampleRate)]),[1]),this.initialized=!0}async process(e){if(!this.initialized||!this.session)throw new Error("SileroVAD not initialized. Call init() first.");const r=typeof ort<"u"?ort:globalThis.ort,n=this.contextSize+this.hopSize,i=new Float32Array(n);if(i.set(this.contextBuffer,0),e.length>=this.hopSize?i.set(e.subarray(0,this.hopSize),this.contextSize):i.set(e,this.contextSize),e.length>=this.contextSize)this.contextBuffer.set(e.subarray(e.length-this.contextSize));else{const d=this.contextSize-e.length;this.contextBuffer.copyWithin(0,e.length),this.contextBuffer.set(e,d)}const o={input:new r.Tensor("float32",i,[1,n]),state:this.stateH,sr:this.srTensor},l=await this.session.run(o),u=l.output.data[0];this.stateH=l.stateN;const f=u>=this.config.threshold;return{probability:u,isSpeech:f,timestamp:Date.now()}}async processBuffer(e){const r=[];for(let n=0;n<e.length;n+=this.hopSize){const i=Math.min(n+this.hopSize,e.length),s=e.subarray(n,i),o=await this.process(s);r.push(o)}return r}reset(){if(!this.initialized)return;const e=typeof ort<"u"?ort:globalThis.ort;this.stateH=new e.Tensor("float32",new Float32Array(256),[2,1,128]),this.contextBuffer.fill(0)}async dispose(){this.session&&(await this.session.release(),this.session=null),this.stateH=null,this.srTensor=null,this.initialized=!1}isReady(){return this.initialized}getHopSize(){return this.hopSize}getConfig(){return{...this.config}}}class gs{config;energyVAD;sileroVAD;state="silence";onsetCounter=0;offsetCounter=0;sileroAccumulator;sileroAccumulatorPos=0;lastSileroProbability=0;sileroReady=!1;constructor(e={}){this.config={sileroThreshold:.5,onsetConfirmations:2,offsetConfirmations:3,sampleRate:16e3,...e},this.energyVAD=new us(this.config.energyConfig),this.sileroVAD=new fs({threshold:this.config.sileroThreshold,sampleRate:this.config.sampleRate,...this.config.sileroConfig});const r=this.sileroVAD.getHopSize();this.sileroAccumulator=new Float32Array(r)}async init(e){await this.sileroVAD.init(e),this.sileroReady=!0}async process(e){const r=this.energyVAD.process(e);let n=null;return this.shouldRunSilero(r)&&this.sileroReady&&(n=await this.runSileroOnChunk(e)),this.updateStateMachine(r,n)}shouldRunSilero(e){if(!this.sileroReady)return!1;switch(this.state){case"silence":return e.isSpeech||e.snr!==void 0&&e.snr>1.5;case"speech_candidate":return!0;case"speech_confirmed":return!0;case"speech_ending":return!0;default:return!1}}async runSileroOnChunk(e){let r=null;for(let n=0;n<e.length;n++)this.sileroAccumulator[this.sileroAccumulatorPos++]=e[n],this.sileroAccumulatorPos>=this.sileroAccumulator.length&&(r=await this.sileroVAD.process(this.sileroAccumulator),this.lastSileroProbability=r.probability,this.sileroAccumulatorPos=0);return r}updateStateMachine(e,r,n=!1){this.state;let i=!1,s=!1;const o=r?r.probability>=this.config.sileroThreshold:!1,l=r?.probability??this.lastSileroProbability,c=n||!this.sileroReady;switch(this.state){case"silence":{c?e.isSpeech&&(this.onsetCounter=1,this.state="speech_candidate"):e.isSpeech&&o?(this.onsetCounter=1,this.state="speech_candidate"):e.isSpeech&&r&&!o&&(this.onsetCounter=0);break}case"speech_candidate":{c?e.isSpeech?(this.onsetCounter++,this.onsetCounter>=this.config.onsetConfirmations&&(this.state="speech_confirmed",this.offsetCounter=0,i=!0)):(this.onsetCounter=0,this.state="silence"):o?(this.onsetCounter++,this.onsetCounter>=this.config.onsetConfirmations&&(this.state="speech_confirmed",this.offsetCounter=0,i=!0)):r&&!o?(this.onsetCounter=0,this.state="silence"):e.isSpeech||(this.onsetCounter=0,this.state="silence");break}case"speech_confirmed":{c?e.isSpeech?this.offsetCounter=0:(this.offsetCounter=1,this.state="speech_ending"):r&&!o?(this.offsetCounter=1,this.state="speech_ending"):!e.isSpeech&&!r?(this.offsetCounter=1,this.state="speech_ending"):this.offsetCounter=0;break}case"speech_ending":{c?e.isSpeech?(this.state="speech_confirmed",this.offsetCounter=0):(this.offsetCounter++,this.offsetCounter>=this.config.offsetConfirmations&&(this.state="silence",this.onsetCounter=0,s=!0)):r&&!o?(this.offsetCounter++,this.offsetCounter>=this.config.offsetConfirmations&&(this.state="silence",this.onsetCounter=0,s=!0)):o?(this.state="speech_confirmed",this.offsetCounter=0):!e.isSpeech&&!r&&(this.offsetCounter++,this.offsetCounter>=this.config.offsetConfirmations&&(this.state="silence",this.onsetCounter=0,s=!0));break}}return{isSpeech:this.state==="speech_confirmed"||this.state==="speech_ending",state:this.state,energy:e.energy,sileroProbability:l||void 0,timestamp:Date.now(),speechStart:i,speechEnd:s,snr:e.snr,noiseFloor:e.noiseFloor}}processEnergyOnly(e){const r=this.energyVAD.process(e);return this.updateStateMachine(r,null,!0)}reset(){this.state="silence",this.onsetCounter=0,this.offsetCounter=0,this.sileroAccumulatorPos=0,this.sileroAccumulator.fill(0),this.lastSileroProbability=0,this.energyVAD.reset(),this.sileroReady&&this.sileroVAD.reset()}async dispose(){await this.sileroVAD.dispose(),this.sileroReady=!1}isReady(){return this.sileroReady}getState(){return this.state}getConfig(){return{...this.config}}getLastSileroProbability(){return this.lastSileroProbability}}class ms{worker;messageId=0;pendingPromises=new Map;resultCallback=null;ready=!1;constructor(){this.worker=new Worker(new URL("/keet/assets/tenvad.worker-DsYonVDv.js",import.meta.url),{type:"module"}),this.worker.onmessage=e=>{this.handleMessage(e.data)},this.worker.onerror=e=>{const r=e;console.error("[TenVADWorkerClient] Worker error:",r.message);for(const[,n]of this.pendingPromises)n.reject(new Error(r.message||"TenVAD worker error"));this.pendingPromises.clear()}}async init(e={}){const r={hopSize:e.hopSize??256,threshold:e.threshold??.5,wasmPath:e.wasmPath??"/wasm/"},n=await this.sendRequest("INIT",r);return this.ready=!0,n}onResult(e){this.resultCallback=e}process(e,r){if(!this.ready)return;const n=new Float32Array(e);this.worker.postMessage({type:"PROCESS",payload:{samples:n,globalSampleOffset:r}},[n.buffer])}processTransfer(e,r){this.ready&&this.worker.postMessage({type:"PROCESS",payload:{samples:e,globalSampleOffset:r}},[e.buffer])}async reset(){await this.sendRequest("RESET",void 0)}dispose(){this.worker.terminate();for(const[,e]of this.pendingPromises)e.reject(new Error("TenVADWorkerClient disposed"));this.pendingPromises.clear(),this.ready=!1,this.resultCallback=null}isReady(){return this.ready}handleMessage(e){if(e.type==="RESULT"){this.resultCallback?.(e.payload);return}if(e.type==="ERROR"){const r=this.pendingPromises.get(e.id);r?(this.pendingPromises.delete(e.id),r.reject(new Error(e.payload))):console.warn("[TenVADWorkerClient] Received ERROR for non-pending request:",e.payload);return}if(e.id!==void 0){const r=this.pendingPromises.get(e.id);r&&(this.pendingPromises.delete(e.id),r.resolve(e.payload))}}sendRequest(e,r){return new Promise((n,i)=>{const s=++this.messageId,l=setTimeout(()=>{this.pendingPromises.has(s)&&(this.pendingPromises.delete(s),i(new Error(`TenVAD request ${e} timed out`)))},e==="INIT"?3e4:5e3);this.pendingPromises.set(s,{resolve:c=>{clearTimeout(l),n(c)},reject:c=>{clearTimeout(l),i(c)}}),this.worker.postMessage({type:e,payload:r,id:s})})}}class ps{config;ringBuffer;vadBuffer;sentenceEnds=[];matureCursorFrame=0;firstSentenceReceived=!1;constructor(e,r=null,n={}){this.ringBuffer=e,this.vadBuffer=r,this.config={sampleRate:16e3,minDurationSec:3,maxDurationSec:30,minInitialDurationSec:1.5,maxSentences:4,useVadBoundaries:!0,vadSilenceThreshold:.3,debug:!1,...n}}markSentenceEnd(e){this.sentenceEnds.push(e),this.sentenceEnds.length>this.config.maxSentences&&(this.sentenceEnds=this.sentenceEnds.slice(-this.config.maxSentences)),this.firstSentenceReceived||(this.firstSentenceReceived=!0,this.config.debug&&console.log(`[WindowBuilder] First sentence received at frame ${e}`))}advanceMatureCursor(e){if(e>this.matureCursorFrame){const r=this.matureCursorFrame;if(this.matureCursorFrame=e,this.config.debug){const n=e/this.config.sampleRate;console.log(`[WindowBuilder] Cursor advanced from frame ${r} to ${e} (${n.toFixed(2)}s)`)}this.firstSentenceReceived||(this.firstSentenceReceived=!0)}}advanceMatureCursorByTime(e){const r=Math.round(e*this.config.sampleRate);this.advanceMatureCursor(r)}getMatureCursorFrame(){return this.matureCursorFrame}getMatureCursorTime(){return this.matureCursorFrame/this.config.sampleRate}buildWindow(){const e=this.ringBuffer.getCurrentFrame(),r=this.ringBuffer.getBaseFrameOffset();if(e===r)return null;const n=e-r;if(!this.firstSentenceReceived){const u=Math.round(this.config.minInitialDurationSec*this.config.sampleRate);if(n<u){if(this.config.debug){const x=n/this.config.sampleRate;console.log(`[WindowBuilder] Initial mode: waiting (${x.toFixed(2)}s / ${this.config.minInitialDurationSec}s)`)}return null}const f=Math.round(this.config.maxDurationSec*this.config.sampleRate),d=Math.min(e,r+f),v=(d-r)/this.config.sampleRate;return this.config.debug&&console.log(`[WindowBuilder] Initial window [${r}:${d}] (${v.toFixed(2)}s)`),{startFrame:r,endFrame:d,durationSeconds:v,isInitial:!0}}let i;if(this.matureCursorFrame>0?i=this.matureCursorFrame:this.sentenceEnds.length>=2?i=this.sentenceEnds[this.sentenceEnds.length-2]:this.sentenceEnds.length>=1?i=this.sentenceEnds[0]:i=r,i<r&&(this.config.debug&&console.log(`[WindowBuilder] Start frame ${i} < base ${r}; clipping to base.`),i=r),i>=e)return this.config.debug&&console.log("[WindowBuilder] Start frame >= end frame, nothing new to transcribe"),null;let s=e-i;const o=Math.round(this.config.minDurationSec*this.config.sampleRate);if(s<o){if(this.config.debug){const u=s/this.config.sampleRate;console.log(`[WindowBuilder] Insufficient audio (${u.toFixed(2)}s < ${this.config.minDurationSec}s). Waiting...`)}return null}const l=Math.round(this.config.maxDurationSec*this.config.sampleRate);if(s>l){const u=e-l;u<this.matureCursorFrame?i=this.matureCursorFrame:i=u,s=e-i}if(this.config.useVadBoundaries&&this.vadBuffer){const u=Math.min(i+Math.round(this.config.sampleRate*.5),e),f=this.vadBuffer.findSilenceBoundary(u,i,this.config.vadSilenceThreshold);if(f>i){const d=e-f;d/this.config.sampleRate>=this.config.minDurationSec&&(this.config.debug&&console.log(`[WindowBuilder] VAD adjusted start: ${i} -> ${f}`),i=f,s=d)}}if(i>=e)return null;const c=(e-i)/this.config.sampleRate;return this.config.debug&&console.log(`[WindowBuilder] Window [${i}:${e}] duration=${c.toFixed(2)}s cursor=${this.matureCursorFrame}`),{startFrame:i,endFrame:e,durationSeconds:c,isInitial:!1}}getSilenceTailDuration(){return this.vadBuffer?this.vadBuffer.getSilenceTailDuration(this.config.vadSilenceThreshold):0}hasSpeechInPendingWindow(){if(!this.vadBuffer)return!0;const e=this.ringBuffer.getCurrentFrame(),r=this.matureCursorFrame>0?this.matureCursorFrame:this.ringBuffer.getBaseFrameOffset();return r>=e?!1:this.vadBuffer.hasSpeechInRange(r,e,this.config.vadSilenceThreshold)}reset(){this.sentenceEnds=[],this.matureCursorFrame=0,this.firstSentenceReceived=!1,this.config.debug&&console.log("[WindowBuilder] Reset")}getConfig(){return{...this.config}}}class vs{worker;messageId=0;pendingPromises=new Map;ready=!1;constructor(){this.worker=new Worker(new URL("/keet/assets/buffer.worker-iRGVlhZN.js",import.meta.url),{type:"module"}),this.worker.onmessage=e=>{this.handleMessage(e.data)},this.worker.onerror=e=>{const r=e;console.error("[BufferWorkerClient] Worker error:",r.message);for(const[,n]of this.pendingPromises)n.reject(new Error(r.message||"BufferWorker error"));this.pendingPromises.clear()}}async init(e){await this.sendRequest("INIT",e),this.ready=!0}async reset(){await this.sendRequest("RESET",void 0)}dispose(){this.worker.terminate();for(const[,e]of this.pendingPromises)e.reject(new Error("BufferWorkerClient disposed"));this.pendingPromises.clear(),this.ready=!1}writeScalar(e,r){this.ready&&this.worker.postMessage({type:"WRITE",payload:{layer:e,data:[r]}})}writeEntry(e,r){if(!this.ready)return;const n=new Float32Array(r);this.worker.postMessage({type:"WRITE",payload:{layer:e,data:n}},[n.buffer])}writeBatch(e,r,n){if(!this.ready)return;const i=new Float32Array(r);this.worker.postMessage({type:"WRITE_BATCH",payload:{layer:e,data:i,globalSampleOffset:n}},[i.buffer])}writeBatchTransfer(e,r,n){this.ready&&this.worker.postMessage({type:"WRITE_BATCH",payload:{layer:e,data:r,globalSampleOffset:n}},[r.buffer])}writeAudio(e){if(!this.ready)return;const r=new Float32Array(e);this.worker.postMessage({type:"WRITE_BATCH",payload:{layer:"audio",data:r}},[r.buffer])}async hasSpeech(e,r,n,i){return this.sendRequest("HAS_SPEECH",{layer:e,startSample:r,endSample:n,threshold:i})}async getVadSummary(e){return this.sendRequest("GET_VAD_SUMMARY",e)}async getSilenceTailDuration(e,r){return(await this.sendRequest("GET_SILENCE_TAIL",{layer:e,threshold:r})).durationSec}async queryRange(e,r,n){return this.sendRequest("QUERY_RANGE",{startSample:e,endSample:r,layers:n})}async getState(){return this.sendRequest("GET_STATE",void 0)}handleMessage(e){if(e.type==="ERROR"){const r=this.pendingPromises.get(e.id);r&&(this.pendingPromises.delete(e.id),r.reject(new Error(e.payload)));return}if(e.id!==void 0){const r=this.pendingPromises.get(e.id);r&&(this.pendingPromises.delete(e.id),r.resolve(e.payload))}}sendRequest(e,r){return new Promise((n,i)=>{const s=++this.messageId;this.pendingPromises.set(s,{resolve:n,reject:i}),this.worker.postMessage({type:e,payload:r,id:s})})}}function bs(t){const e=Math.floor(t/3600),r=Math.floor(t%3600/60),n=t%60;return`${e>0?e.toString().padStart(2,"0")+":":""}${r.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}`}var ys=L('<div class="flex items-center gap-2"><button type=button>Live</button><button type=button><span>Timeline</span><span>'),Ss=L('<header class="h-20 flex items-center justify-between px-8 bg-[var(--color-earthy-bg)]/80 backdrop-blur-sm z-30 shrink-0"><div class="flex items-center gap-6"><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-full bg-[var(--color-earthy-muted-green)] flex items-center justify-center text-white"><span class="material-symbols-outlined text-xl">auto_awesome</span></div><div><div class="flex items-baseline gap-1.5"><h1 class="text-lg font-semibold tracking-tight text-[var(--color-earthy-dark-brown)]">keet</h1><span class="text-[9px] uppercase tracking-[0.14em] text-[var(--color-earthy-soft-brown)]/80 font-medium"></span></div><p class="text-[10px] uppercase tracking-[0.2em] text-[var(--color-earthy-soft-brown)] font-medium"></p><p class="text-[9px] text-[var(--color-earthy-soft-brown)]/80 font-medium"></p></div></div></div><div class="flex items-center gap-4"><button type=button aria-label="Toggle debug panel"><span class=material-symbols-outlined>bug_report'),xs=L('<div class="flex items-center gap-2 px-1"><div class="flex-1 h-1.5 rounded-full overflow-hidden bg-[var(--color-earthy-sage)]/20"><div class="h-full bg-[var(--color-earthy-muted-green)] rounded-full transition-all duration-300"></div></div><span class="text-[10px] font-mono text-[var(--color-earthy-soft-brown)] tabular-nums">%'),ws=L('<span class="material-symbols-outlined load-btn-spin">progress_activity'),Cs=L('<div class="h-screen flex flex-col overflow-hidden bg-[var(--color-earthy-bg)] selection:bg-[var(--color-earthy-coral)] selection:text-white"><div class="flex-1 flex flex-col min-h-0 overflow-hidden"><div class="flex-1 min-h-0 overflow-hidden flex flex-col"><main class="flex-1 min-h-0 overflow-hidden px-1 sm:px-2 lg:px-3 xl:px-4 2xl:px-5 flex flex-col items-center"><div class="w-full max-w-[92%] 2xl:max-w-[1680px] py-1 md:py-2 lg:py-3 flex-1 min-h-0 flex flex-col"></div></main></div></div><div><div class=relative><div class="absolute left-0 right-0 overflow-hidden transition-[max-height] duration-300 ease-out"><div class="max-h-[70vh] min-h-0 flex flex-col overflow-y-auto custom-scrollbar"></div></div><div class="bg-white/90 backdrop-blur-md shadow-lg border border-[var(--color-earthy-sage)]/30 rounded-2xl overflow-hidden"role=presentation><div class="p-4 flex items-center justify-between gap-6 cursor-grab active:cursor-grabbing"><div class="flex items-center gap-2 flex-shrink-0"><span class="material-symbols-outlined text-[var(--color-earthy-soft-brown)] text-lg opacity-60"aria-hidden=true>drag_indicator</span><div class="flex flex-col min-w-[60px]"><span class="text-[10px] uppercase tracking-wider text-[var(--color-earthy-soft-brown)] font-bold">Rec</span><span class="font-mono text-sm text-[var(--color-earthy-dark-brown)]"></span></div></div><div class="flex-1 min-w-0 flex flex-col justify-center gap-1"><div class="h-8 flex items-center justify-center gap-1 overflow-hidden opacity-80 abstract-wave"></div></div><div class="flex items-center gap-2 flex-shrink-0"><button type=button><span class=material-symbols-outlined>mic</span></button><button type=button class="w-10 h-10 rounded-full flex items-center justify-center text-[var(--color-earthy-dark-brown)] hover:bg-[var(--color-earthy-bg)] transition-colors border border-transparent hover:border-[var(--color-earthy-sage)]/30 disabled:opacity-40 disabled:cursor-not-allowed relative"></button><button type=button title=Settings><span class=material-symbols-outlined>tune</span></button><button type=button class="w-10 h-10 rounded-full flex items-center justify-center text-[var(--color-earthy-dark-brown)] hover:bg-[var(--color-earthy-bg)] transition-colors border border-transparent hover:border-[var(--color-earthy-sage)]/30 disabled:opacity-40 disabled:cursor-not-allowed"title=Pause><span class=material-symbols-outlined>pause</span></button><button type=button class="w-10 h-10 rounded-full flex items-center justify-center text-[var(--color-earthy-dark-brown)] hover:bg-[var(--color-earthy-bg)] transition-colors border border-transparent hover:border-[var(--color-earthy-sage)]/30"title="Copy transcript"><span class=material-symbols-outlined>content_copy'),Ts=L("<span class=material-symbols-outlined>power_settings_new");let le=null;const[Zr,_s]=$(null);let ee=null,me=null;const[$s,Wt]=$(null);let Sr=null,xr=null,wr=null,Ut,Ht=null,Ae=null,He=null,je=null,jt,Rt=!1,Gt=null,qt=null,It=!1,Cr=0,At=0,Tr=null,_r=!1,pt=null,$r=!1;const vt={enabled:0,bypassNonPositivePrefix:0,bypassOutsideWindow:0},Mr=(t,e)=>{vt[t]++,vt.enabled+vt.bypassNonPositivePrefix+vt.bypassOutsideWindow},Ms=t=>{Tr=t,!_r&&(_r=!0,requestAnimationFrame(()=>{if(_r=!1,Tr===null)return;const e=a.vadState();a.setVadState({...e,sileroProbability:Tr})}))},Es=t=>{pt=t,!$r&&($r=!0,requestAnimationFrame(()=>{if($r=!1,!pt)return;const e=a.vadState(),r=pt.sileroProbability!==void 0?pt.sileroProbability:e.sileroProbability;a.setVadState({...e,...pt,sileroProbability:r}),a.setIsSpeechDetected(pt.isSpeech),pt=null}))},ks=t=>{const e="v1.1.2",r="parakeet.js 1.2.1 (npm)",n=()=>a.modelState()==="ready"?un(a.selectedModelId()):"Session";return(()=>{var i=Ss(),s=i.firstChild,o=s.firstChild,l=o.firstChild,c=l.nextSibling,u=c.firstChild,f=u.firstChild,d=f.nextSibling,v=u.nextSibling,x=v.nextSibling,T=s.nextSibling,w=T.firstChild;return m(d,e),m(v,n),m(x,r),m(T,O(ie,{get when(){return t.isV4Mode},get children(){var S=ys(),M=S.firstChild,k=M.nextSibling,p=k.firstChild,R=p.nextSibling;return M.$$click=()=>t.onTranscriptTabChange("live"),k.$$click=()=>t.onTranscriptTabChange("merged"),m(R,()=>t.timelineCount),Q(A=>{var H=`px-3 py-1.5 rounded-lg text-xs font-semibold uppercase tracking-wide border transition-colors ${t.activeTranscriptTab==="live"?"bg-[var(--color-earthy-muted-green)] text-white border-[var(--color-earthy-muted-green)]":"bg-[var(--color-earthy-bg)] text-[var(--color-earthy-soft-brown)] border-[var(--color-earthy-sage)]/50 hover:border-[var(--color-earthy-soft-brown)]"}`,W=`px-3 py-1.5 rounded-lg text-xs font-semibold uppercase tracking-wide border transition-colors flex items-center gap-2 ${t.activeTranscriptTab==="merged"?"bg-[var(--color-earthy-muted-green)] text-white border-[var(--color-earthy-muted-green)]":"bg-[var(--color-earthy-bg)] text-[var(--color-earthy-soft-brown)] border-[var(--color-earthy-sage)]/50 hover:border-[var(--color-earthy-soft-brown)]"}`,D=`px-1.5 py-0.5 rounded text-[10px] leading-none ${t.activeTranscriptTab==="merged"?"bg-white/20":"bg-[var(--color-earthy-sage)]/30"}`;return H!==A.e&&oe(M,A.e=H),W!==A.t&&oe(k,A.t=W),D!==A.a&&oe(R,A.a=D),A},{e:void 0,t:void 0,a:void 0}),S}}),w),sn(w,"click",t.onToggleDebug),Q(S=>{var M=`w-9 h-9 inline-flex items-center justify-center rounded-full transition-colors leading-none ${a.showDebugPanel()?"bg-[var(--color-earthy-muted-green)] text-white":"text-[var(--color-earthy-muted-green)] hover:bg-[var(--color-earthy-sage)]/30"}`,k=a.showDebugPanel()?"Hide debug panel":"Show debug panel";return M!==S.e&&oe(w,S.e=M),k!==S.t&&Lt(w,"title",S.t=k),S},{e:void 0,t:void 0}),i})()},Dr=672,gn=80,Rs=150,Is=()=>{const t=typeof window<"u"?window.innerWidth:800,e=typeof window<"u"?window.innerHeight:600;return{x:Math.max(0,(t-Dr)/2),y:Math.max(0,e-140)}},As=t=>typeof window>"u"?t:{x:Math.max(0,Math.min(window.innerWidth-Dr,t.x)),y:Math.max(0,Math.min(window.innerHeight-gn,t.y))},Ds=()=>{const t=Jn(),e=t.general,r=t.audio,n=t.model,i=n?.selectedModelId,s=t.ui,o=n?.encoderQuant!==void 0,l=n?.decoderQuant!==void 0;i&&nr.some(y=>y.id===i)&&a.setSelectedModelId(i),n?.backend!==void 0&&a.setModelBackendMode(n.backend),n?.encoderQuant!==void 0&&a.setEncoderQuant(n.encoderQuant),n?.decoderQuant!==void 0&&a.setDecoderQuant(n.decoderQuant),e?.energyThreshold!==void 0&&a.setEnergyThreshold(e.energyThreshold),e?.sileroThreshold!==void 0&&a.setSileroThreshold(e.sileroThreshold),e?.v4InferenceIntervalMs!==void 0&&a.setV4InferenceIntervalMs(e.v4InferenceIntervalMs),e?.v4SilenceFlushSec!==void 0&&a.setV4SilenceFlushSec(e.v4SilenceFlushSec),e?.streamingWindow!==void 0&&a.setStreamingWindow(e.streamingWindow),e?.frameStride!==void 0&&a.setFrameStride(e.frameStride),e?.wasmThreads!==void 0&&a.setWasmThreads(Ln(e.wasmThreads)),s?.debugPanel?.visible!==void 0&&a.setShowDebugPanel(s.debugPanel.visible);const c=s?.widgetPosition?As(s.widgetPosition):Is(),u=s?.transcript?.activeTab??"live",f=s?.transcript?.mergedSplitRatio!==void 0?Tt(s.transcript.mergedSplitRatio):cn,d=s?.debugPanel?.height!==void 0?dn(s.debugPanel.height):ln,[v,x]=$(!1),[T,w]=$(!1),[S,M]=$("full");let k;const[p,R]=$(!1),[A,H]=$(c),[W,D]=$(!1),[P,N]=$(u),[G,Y]=$(f),[_,h]=$(d),[g,b]=$(!1);let C,E,I,F,Z;const z=()=>a.recordingState()==="recording",te=()=>a.modelState()==="ready",re=()=>a.transcriptionMode()==="v4-utterance",ae=Re(()=>a.v4SentenceEntries().length+(a.immatureText().trim()?1:0));Ve(()=>{!re()&&P()!=="live"&&N("live")});const ve=(y,V={})=>{const ne=V.respectPersistedQuant===!0;if(y.startsWith("webgpu")){(!ne||!o)&&a.encoderQuant()!=="fp32"&&a.setEncoderQuant("fp32"),(!ne||!l)&&a.decoderQuant()!=="int8"&&a.setDecoderQuant("int8");return}(!ne||!o)&&a.encoderQuant()!=="int8"&&a.setEncoderQuant("int8"),(!ne||!l)&&a.decoderQuant()!=="int8"&&a.setDecoderQuant("int8")};let he=null;Ve(()=>{const y=a.modelBackendMode();if(he===null){ve(y,{respectPersistedQuant:!0}),he=y;return}y!==he&&(ve(y),he=y)});let ue={x:0,y:0},X={x:0,y:0};const[be,J]=$(typeof window<"u"?window.innerHeight:600),Te=()=>Math.max(er,Math.min(Ft,be()-200)),_e=()=>{const y=A();return y?y.y>=be()/2:!0};Ve(()=>{const y=_(),V=Te();y>V&&h(V)});const et=y=>{if(y.target.closest("button, select, input"))return;y.preventDefault();const V=A();if(!V)return;D(!0),ue={x:y.clientX,y:y.clientY},X={...V};const ne=U=>{const fe=U.clientX-ue.x,ge=U.clientY-ue.y,ce=typeof window<"u"?window.innerWidth:800,se=typeof window<"u"?window.innerHeight:600,Me=Math.max(0,Math.min(ce-Dr,X.x+fe)),j=Math.max(0,Math.min(se-gn,X.y+ge));H({x:Me,y:j})},Se=()=>{D(!1),window.removeEventListener("mousemove",ne),window.removeEventListener("mouseup",Se)};window.addEventListener("mousemove",ne),window.addEventListener("mouseup",Se)};Ve(()=>{if(!T())return;const y=V=>{V.key==="Escape"&&(V.preventDefault(),w(!1))};return document.addEventListener("keydown",y),()=>document.removeEventListener("keydown",y)}),Ve(()=>{a.modelState()==="ready"&&T()&&S()==="model"&&w(!1)});const qe=()=>{const y=a.selectedDeviceId(),V=a.availableDevices().find(ne=>ne.deviceId===y);return{general:{energyThreshold:a.energyThreshold(),sileroThreshold:a.sileroThreshold(),v4InferenceIntervalMs:a.v4InferenceIntervalMs(),v4SilenceFlushSec:a.v4SilenceFlushSec(),streamingWindow:a.streamingWindow(),frameStride:a.frameStride(),wasmThreads:a.wasmThreads()},model:{selectedModelId:a.selectedModelId(),backend:a.modelBackendMode(),encoderQuant:a.encoderQuant(),decoderQuant:a.decoderQuant()},audio:{selectedDeviceId:y,selectedDeviceLabel:V?.label},ui:{widgetPosition:A()??void 0,debugPanel:{visible:a.showDebugPanel(),height:_()},transcript:{activeTab:P(),mergedSplitRatio:G()}}}},De=()=>{g()&&(C&&(clearTimeout(C),C=void 0),Wr(qe()))};Ve(()=>{if(!g())return;const y=qe();C&&clearTimeout(C),C=window.setTimeout(()=>{Wr(y),C=void 0},Rs)}),Rr(()=>{E=()=>J(window.innerHeight),I=()=>De(),F=()=>De(),Z=()=>{document.visibilityState==="hidden"&&De()},window.addEventListener("resize",E),window.addEventListener("beforeunload",I),window.addEventListener("pagehide",F),document.addEventListener("visibilitychange",Z),ee=new hs,ee.onModelProgress=y=>{a.setModelProgress(y.progress),a.setModelMessage(y.message||""),y.file&&a.setModelFile(y.file),y.backend&&a.setBackend(y.backend)},ee.onModelStateChange=y=>{a.setModelState(y)},ee.onV3Confirmed=y=>{a.setTranscript(y)},ee.onV3Pending=y=>{a.setPendingText(y)},ee.onError=y=>{a.setErrorMessage(y)},a.refreshDevices({preferredDeviceId:r?.selectedDeviceId,preferredDeviceLabel:r?.selectedDeviceLabel}).finally(()=>{b(!0)}),R(!0)}),bt(()=>{E&&window.removeEventListener("resize",E),I&&window.removeEventListener("beforeunload",I),F&&window.removeEventListener("pagehide",F),Z&&document.removeEventListener("visibilitychange",Z),clearTimeout(k),De(),Ut?.(),Oe(),me?.dispose(),ee?.dispose()});let ye=!1;const Qe=async()=>{if(!ee||!je||!le||!Ae||It)return;if(a.modelState()!=="ready"){ye||(ye=!0);return}ye&&(ye=!1,await ee.initV4Service({debug:!1}));const y=performance.now(),V=Math.max(200,a.v4InferenceIntervalMs()-100);if(y-Cr<V)return;const ne=je.getMatureCursorFrame(),Se=At,U=ne>0?ne:0,fe=He?.isReady()??!1,ge=await Ae.getVadSummary({startSample:U,endSample:Se,energyThreshold:.3,inferenceThreshold:.5,requireInference:fe});if(!ge.hasSpeech){if(ge.silenceTailDurationSec>=a.v4SilenceFlushSec())try{const j=await ee.v4FinalizeTimeout();j&&(Lr(()=>{a.setMatureText(j.matureText),a.setImmatureText(j.immatureText),a.setMatureCursorTime(j.matureCursorTime),a.setTranscript(j.fullText),a.appendV4SentenceEntries(j.matureSentences),a.setV4MergerStats({sentencesFinalized:j.matureSentenceCount,cursorUpdates:j.stats?.matureCursorUpdates||0,utterancesProcessed:j.stats?.utterancesProcessed||0})}),je.advanceMatureCursorByTime(j.matureCursorTime))}catch(j){console.error("[v4Tick] Flush error:",j)}return}const se=je.buildWindow();if(se){It=!0,Cr=y;try{const Me=performance.now();let j=null;if(me&&(j=await me.getFeatures(se.startFrame,se.endFrame)),!j){It=!1;return}const ze=se.startFrame/16e3,ke=je.getMatureCursorFrame(),Pe=ke>0?(se.startFrame-ke)/16e3:0;let Ze;Pe<=0?Mr("bypassNonPositivePrefix",{rawPrefixSeconds:Pe,windowDurationSeconds:se.durationSeconds}):Pe>=se.durationSeconds?Mr("bypassOutsideWindow",{rawPrefixSeconds:Pe,windowDurationSeconds:se.durationSeconds}):(Ze={cacheKey:"v4-stream",prefixSeconds:Pe},Mr("enabled",{rawPrefixSeconds:Pe,windowDurationSeconds:se.durationSeconds}));const xe=await ee.processV4ChunkWithFeatures({features:j.features,T:j.T,melBins:j.melBins,frameStride:a.frameStride(),timeOffset:ze,endTime:se.endFrame/16e3,segmentId:`v4_${Date.now()}`,incrementalCache:Ze});if(!Rt)return;const Be=performance.now()-Me,rt=se.durationSeconds*1e3,nt=xe.matureCursorTime>je.getMatureCursorTime(),Ee=le.getRingBuffer();Lr(()=>{a.setMatureText(xe.matureText),a.setImmatureText(xe.immatureText),a.setTranscript(xe.fullText),a.setPendingText(xe.immatureText),a.appendV4SentenceEntries(xe.matureSentences),a.setInferenceLatency(Be),a.setRtf(Be/rt),nt&&a.setMatureCursorTime(xe.matureCursorTime),a.setV4MergerStats({sentencesFinalized:xe.matureSentenceCount,cursorUpdates:xe.stats?.matureCursorUpdates||0,utterancesProcessed:xe.stats?.utterancesProcessed||0}),a.setBufferMetrics({fillRatio:Ee.getFillCount()/Ee.getSize(),latencyMs:Ee.getFillCount()/16e3*1e3}),xe.metrics&&a.setSystemMetrics({throughput:0,modelConfidence:0})}),nt&&(je.advanceMatureCursorByTime(xe.matureCursorTime),je.markSentenceEnd(Math.round(xe.matureCursorTime*16e3)))}catch(Me){console.error("[v4Tick] Inference error:",Me)}finally{It=!1}}},Oe=()=>{Rt=!1,jt&&(clearTimeout(jt),jt=void 0),Gt&&(Gt(),Gt=null),qt&&(qt(),qt=null),Ht=null,He&&(He.dispose(),He=null),Ae&&(Ae.dispose(),Ae=null),je=null,It=!1,Cr=0,At=0,vt.enabled=0,vt.bypassNonPositivePrefix=0,vt.bypassOutsideWindow=0},Ye=async()=>{if(z()){Ut?.(),Ut=void 0,a.stopRecording(),a.setAudioLevel(0),a.setBarLevels(new Float32Array(0));try{if(le?.stop(),Sr&&Sr(),xr&&xr(),wr&&wr(),Oe(),ee){const y=await ee.finalize();let V="";"text"in y&&typeof y.text=="string"?V=y.text:"fullText"in y&&typeof y.fullText=="string"&&(V=y.fullText),a.setTranscript(V),a.setPendingText("")}me?.reset(),le?.reset()}catch(y){console.warn("[App] Error during stop recording cleanup:",y)}}else try{le?(le.updateConfig({deviceId:a.selectedDeviceId()}),le.reset()):(le=new ds({sampleRate:16e3,deviceId:a.selectedDeviceId()}),_s(le));const y=a.transcriptionMode();if(y==="v4-utterance"){te()&&ee&&await ee.initV4Service({debug:!1}),me||(me=new Yr,Wt(me));try{await me.init({nMels:128})}catch{me.dispose(),me=null,Wt(null)}Ae=new vs;const V={sampleRate:16e3,layers:{audio:{hopSamples:1,entryDimension:1,maxDurationSec:5},mel:{hopSamples:160,entryDimension:128,maxDurationSec:5},energyVad:{hopSamples:1280,entryDimension:1,maxDurationSec:120},inferenceVad:{hopSamples:256,entryDimension:1,maxDurationSec:120}}};await Ae.init(V),He=new ms,He.onResult(U=>{if(Ae&&U.hopCount>0){const fe=U.probabilities[U.hopCount-1];Ae.writeBatchTransfer?Ae.writeBatchTransfer("inferenceVad",U.probabilities,U.globalSampleOffset):Ae.writeBatch("inferenceVad",U.probabilities,U.globalSampleOffset),Ms(fe)}}),He.init({hopSize:256,threshold:.5,wasmPath:"/keet/wasm/"}).catch(U=>{console.warn("[v4] TEN-VAD init failed, using energy-only:",U)}),Ht=new gs({sileroThreshold:.5,onsetConfirmations:2,offsetConfirmations:3,sampleRate:16e3}),At=0,qt=null,Gt=le.onAudioChunk(U=>{if(!Ht||!Ae)return;const fe=At;At+=U.length;const ge=Ht.processEnergyOnly(U),ce=ge.isSpeech?.9:.1;Ae.writeScalar("energyVad",ce),me?.pushAudioCopy(U),He?.isReady()&&He.process(U,fe);const se=He?.isReady()?void 0:ge.sileroProbability||0;Es({isSpeech:ge.isSpeech,energy:ge.energy,snr:ge.snr||0,hybridState:ge.state,...se!==void 0?{sileroProbability:se}:{}})}),Rt=!0;const Se=()=>{Rt&&(jt=window.setTimeout(async()=>{Rt&&(await Qe(),Se())},a.v4InferenceIntervalMs()))};Se()}else if(te()&&ee)if(y==="v3-streaming"){const V=a.streamingWindow(),ne=a.triggerInterval(),Se=Math.max(1,V-ne);await ee.initV3Service({windowDuration:V,overlapDuration:Se,sampleRate:16e3,frameStride:a.frameStride()}),me||(me=new Yr,Wt(me));try{await me.init({nMels:128})}catch{me.dispose(),me=null,Wt(null)}wr=le.onAudioChunk(U=>{me?.pushAudioCopy(U)}),xr=le.onWindowChunk(V,Se,ne,async(U,fe)=>{if(!ee)return;const ge=performance.now();let ce;if(me){const j=Math.round(fe*16e3),ze=j+U.length,ke=await me.getFeatures(j,ze);ke?ce=await ee.processV3ChunkWithFeatures(ke.features,ke.T,ke.melBins,fe,Se):ce=await ee.processV3Chunk(U,fe)}else ce=await ee.processV3Chunk(U,fe);const se=performance.now()-ge,Me=a.triggerInterval();if(a.setRtf(se/(Me*1e3)),a.setInferenceLatency(se),le){const j=le.getRingBuffer();a.setBufferMetrics({fillRatio:j.getFillCount()/j.getSize(),latencyMs:j.getFillCount()/16e3*1e3})}a.setMergeInfo({lcsLength:ce.lcsLength,anchorValid:ce.anchorValid,chunkCount:ce.chunkCount,anchorTokens:ce.anchorTokens})})}else await ee.initService({sampleRate:16e3}),Sr=le.onSpeechSegment(async V=>{if(ee){const ne=Date.now(),Se=le.getRingBuffer().read(V.startFrame,V.endFrame),U=await ee.transcribeSegment(Se);U.text&&a.appendTranscript(U.text+" "),a.setInferenceLatency(Date.now()-ne)}});await le.start(),y==="v4-utterance"&&(je=new ps(le.getRingBuffer(),null,{sampleRate:16e3,minDurationSec:3,maxDurationSec:30,minInitialDurationSec:1.5,useVadBoundaries:!1,vadSilenceThreshold:.3,debug:!1})),a.startRecording(),Ut=le.onVisualizationUpdate((V,ne)=>{a.setAudioLevel(ne.currentEnergy),a.transcriptionMode()!=="v4-utterance"&&a.setIsSpeechDetected(le?.isSpeechActive()??!1),a.setBarLevels(le.getBarLevels())})}catch(y){const V=y instanceof Error?y.message:String(y);a.setErrorMessage(V)}},Fe=async()=>{if(ee&&a.modelState()!=="loading"){if(a.recordingState()==="recording"){console.warn("[App] Model reload blocked while recording is active");return}w(!0);try{await ee.initModel({modelId:a.selectedModelId(),cpuThreads:a.wasmThreads(),backend:a.modelBackendMode(),encoderQuant:a.encoderQuant(),decoderQuant:a.decoderQuant()})}catch(y){console.error("Failed to load model:",y),a.setModelState("error"),a.setErrorMessage(y instanceof Error?y.message:String(y))}}},Mt=()=>{clearTimeout(k),M("audio"),w(!0)},Et=()=>{clearTimeout(k),M("model"),w(!0)},tt=()=>{k=window.setTimeout(()=>{S()!=="full"&&a.modelState()!=="loading"&&w(!1)},250)},St=()=>clearTimeout(k),kt=()=>{S()!=="full"&&tt()},xt=async y=>{if(ee){w(!0);try{await ee.initLocalModel(y,{cpuThreads:a.wasmThreads(),backend:a.modelBackendMode()})}catch(V){console.error("Failed to load local model:",V)}}};return(()=>{var y=Cs(),V=y.firstChild,ne=V.firstChild,Se=ne.firstChild,U=Se.firstChild,fe=V.nextSibling,ge=fe.firstChild,ce=ge.firstChild,se=ce.firstChild,Me=ce.nextSibling,j=Me.firstChild,ze=j.firstChild,ke=ze.firstChild,Pe=ke.nextSibling,Ze=Pe.firstChild,xe=Ze.nextSibling,Be=ze.nextSibling,rt=Be.firstChild,nt=Be.nextSibling,Ee=nt.firstChild,Ne=Ee.nextSibling,it=Ne.nextSibling,dt=it.nextSibling,wt=dt.nextSibling;return m(y,O(Ei,{get isVisible(){return v()},get state(){return a.modelState()},get progress(){return a.modelProgress()},get message(){return a.modelMessage()},get file(){return a.modelFile()},get backend(){return a.backend()},get selectedModelId(){return a.selectedModelId()},onModelSelect:q=>a.setSelectedModelId(q),onStart:()=>Fe(),onLocalLoad:xt,onClose:()=>x(!1)}),V),m(y,O(ks,{onToggleDebug:()=>a.setShowDebugPanel(!a.showDebugPanel()),get isV4Mode(){return re()},get activeTranscriptTab(){return P()},onTranscriptTabChange:N,get timelineCount(){return ae()}}),V),m(U,O(mi,{get confirmedText(){return Ge(()=>a.transcriptionMode()==="v4-utterance")()?a.matureText():a.transcript()},get pendingText(){return Ge(()=>a.transcriptionMode()==="v4-utterance")()?a.immatureText():a.pendingText()},get sentenceEntries(){return a.v4SentenceEntries()},get isV4Mode(){return a.transcriptionMode()==="v4-utterance"},get isRecording(){return z()},get lcsLength(){return a.mergeInfo().lcsLength},get anchorValid(){return a.mergeInfo().anchorValid},get showConfidence(){return a.transcriptionMode()==="v3-streaming"},get activeTab(){return P()},onTabChange:N,get mergedSplitRatio(){return G()},onMergedSplitRatioChange:Y,class:"min-h-0 h-full"})),m(V,O(ie,{get when(){return a.showDebugPanel()},get children(){return O(Ri,{get audioEngine(){return Zr()??void 0},get melClient(){return $s()??void 0},get height(){return _()},get maxHeight(){return Te()},onHeightChange:h})}}),null),ce.addEventListener("mouseleave",kt),ce.addEventListener("mouseenter",St),m(se,O(Ui,{get section(){return S()},onClose:()=>w(!1),onLoadModel:()=>Fe(),onLocalLoad:xt,onOpenDebug:()=>a.setShowDebugPanel(!0),onDeviceSelect:q=>{le&&le.updateConfig({deviceId:q})},get audioEngine(){return Zr()??void 0},expandUp:_e})),Me.$$mousedown=et,m(xe,()=>bs(a.sessionDuration())),m(rt,O(bi,{get audioLevel(){return a.audioLevel()},get barLevels(){return a.barLevels()},get isRecording(){return z()}})),m(Be,O(ie,{get when(){return a.modelState()==="loading"},get children(){var q=xs(),Ke=q.firstChild,We=Ke.firstChild,st=Ke.nextSibling,Ue=st.firstChild;return m(st,()=>Math.round(a.modelProgress()),Ue),Q(ht=>Le(We,"width",`${Math.max(0,Math.min(100,a.modelProgress()))}%`)),q}}),null),Ee.addEventListener("mouseleave",tt),Ee.addEventListener("mouseenter",Mt),Ee.$$click=Ye,Ne.addEventListener("mouseleave",tt),Ne.addEventListener("mouseenter",Et),Ne.$$click=()=>Fe(),m(Ne,O(ie,{get when(){return a.modelState()==="loading"},get fallback(){return Ts()},get children(){return ws()}})),it.$$click=()=>{M("full"),w(q=>!q)},dt.$$click=()=>z()&&Ye(),wt.$$click=()=>a.copyTranscript(),Q(q=>{var Ke=A()!==null?"fixed z-30 w-full max-w-2xl px-6 select-none":"absolute bottom-8 left-1/2 -translate-x-1/2 z-30 w-full max-w-2xl px-6",We=A()?{left:`${A().x}px`,top:`${A().y}px`}:{},st={"max-h-0":!T(),"max-h-[70vh]":T(),"pointer-events-none border-transparent bg-transparent shadow-none":!T(),"pointer-events-auto border border-[var(--color-earthy-sage)]/30 bg-[var(--color-earthy-bg)]/95 backdrop-blur-sm shadow-lg":T(),"bottom-full rounded-t-2xl border-b-0":T()&&_e(),"top-full rounded-b-2xl border-t-0":T()&&!_e()},Ue=`w-10 h-10 rounded-full flex items-center justify-center transition-colors border ${z()?"bg-[var(--color-earthy-coral)] text-white border-[var(--color-earthy-coral)]":"text-[var(--color-earthy-dark-brown)] hover:bg-[var(--color-earthy-bg)] border-transparent hover:border-[var(--color-earthy-sage)]/30"}`,ht=z()?"Stop recording":"Start recording",B=a.modelState()==="loading"||a.modelState()==="ready",ut=a.modelState()==="ready"?"Model loaded":a.modelState()==="loading"?"Loading...":"Load model",ft=`w-10 h-10 rounded-full flex items-center justify-center transition-colors border ${T()?"bg-[var(--color-earthy-sage)]/30 text-[var(--color-earthy-muted-green)] border-[var(--color-earthy-sage)]/50":"text-[var(--color-earthy-dark-brown)] hover:bg-[var(--color-earthy-bg)] border-transparent hover:border-[var(--color-earthy-sage)]/30"}`,gt=!z();return Ke!==q.e&&oe(fe,q.e=Ke),q.t=Fn(fe,We,q.t),q.a=Dn(ce,st,q.a),Ue!==q.o&&oe(Ee,q.o=Ue),ht!==q.i&&Lt(Ee,"title",q.i=ht),B!==q.n&&(Ne.disabled=q.n=B),ut!==q.s&&Lt(Ne,"title",q.s=ut),ft!==q.h&&oe(it,q.h=ft),gt!==q.r&&(dt.disabled=q.r=gt),q},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0,r:void 0}),y})()};yt(["click","mousedown"]);const mn=document.getElementById("root");if(!mn)throw new Error("Root element not found");An(()=>O(Ds,{}),mn);
