const b={SAMPLE_RATE:16e3,N_FFT:512,WIN_LENGTH:400,HOP_LENGTH:160,PREEMPH:.97,LOG_ZERO_GUARD:5960464477539063e-23,N_FREQ_BINS:257},P=200/3,L=1e3,O=L/P,U=Math.log(6.4)/27;function k(e){return e>=L?O+Math.log(e/L)/U:e/P}function Q(e){return e>=O?L*Math.exp(U*(e-O)):e*P}function Z(e){const{SAMPLE_RATE:r,N_FREQ_BINS:s}=b,o=r/2,t=new Float64Array(s);for(let c=0;c<s;c++)t[c]=o*c/(s-1);const l=k(0),i=k(o),n=e+2,f=new Float64Array(n);for(let c=0;c<n;c++)f[c]=Q(l+(i-l)*c/(n-1));const p=new Float64Array(n-1);for(let c=0;c<n-1;c++)p[c]=f[c+1]-f[c];const a=new Float32Array(e*s);for(let c=0;c<e;c++){const M=2/(f[c+2]-f[c]),d=c*s;for(let S=0;S<s;S++){const $=(t[S]-f[c])/p[c],C=(f[c+2]-t[S])/p[c+1];a[d+S]=Math.max(0,Math.min($,C))*M}}return a}function j(){const{N_FFT:e,WIN_LENGTH:r}=b,s=new Float64Array(e),o=e-r>>1;for(let t=0;t<r;t++)s[o+t]=.5*(1-Math.cos(2*Math.PI*t/(r-1)));return s}function q(e){const r=e>>1,s=new Float64Array(r),o=new Float64Array(r);for(let t=0;t<r;t++){const l=-2*Math.PI*t/e;s[t]=Math.cos(l),o[t]=Math.sin(l)}return{cos:s,sin:o}}function V(e,r,s,o){for(let t=1,l=0;t<s;t++){let i=s>>1;for(;l&i;)l^=i,i>>=1;if(l^=i,t<l){let n=e[t];e[t]=e[l],e[l]=n,n=r[t],r[t]=r[l],r[l]=n}}for(let t=2;t<=s;t<<=1){const l=t>>1,i=s/t;for(let n=0;n<s;n+=t)for(let f=0;f<l;f++){const p=f*i,a=e[n+f+l]*o.cos[p]-r[n+f+l]*o.sin[p],c=e[n+f+l]*o.sin[p]+r[n+f+l]*o.cos[p];e[n+f+l]=e[n+f]-a,r[n+f+l]=r[n+f]-c,e[n+f]+=a,r[n+f]+=c}}}function J(e,r,s){const o=new Float32Array(e.length);for(let t=0;t<r;t++){const l=t*s;let i=0;for(let a=0;a<s;a++)o[l+a]=e[l+a],i+=e[l+a];const n=i/s;let f=0;for(let a=0;a<s;a++){const c=o[l+a]-n;f+=c*c}const p=s>1?1/(Math.sqrt(f/(s-1))+1e-5):0;for(let a=0;a<s;a++)o[l+a]=(o[l+a]-n)*p}return o}function B(e){return Math.floor(e/b.HOP_LENGTH)}const{N_FFT:w,HOP_LENGTH:G,N_FREQ_BINS:R,PREEMPH:H,LOG_ZERO_GUARD:K}=b;let F=128,_=new Float32Array(0),A=0,E=0,I=0,g=0,y=null,m=0,u=0,T=0,h,N,x,W,z,v;function X(e){performance.now(),F=e.nMels||128,W=Z(F),z=j(),v=q(w),h=new Float64Array(w),N=new Float64Array(w),x=new Float32Array(R),m=12e3,y=new Float32Array(F*m),u=0,T=0,_=new Float32Array(w+16e3),A=0,E=0,I=0,g=0,(F*m*4/1024/1024).toFixed(1)}function Y(e){if(!y)return;const r=e.length;if(r===0)return;const s=performance.now();if(E+r>_.length){const n=Math.max(_.length*2,E+r),f=new Float32Array(n);f.set(_.subarray(0,E)),_=f}_[E]=e[0]-H*I;for(let n=1;n<r;n++)_[E+n]=e[n]-H*e[n-1];E+=r,I=e[r-1],g+=r;const o=Math.floor(g/G);if(o<=u){D();return}const t=w>>1;for(let n=u;n<o;n++){const f=n*G-t,p=n%m;for(let a=0;a<w;a++){const M=f+a-A,d=M>=0&&M<E?_[M]:0;h[a]=d*z[a],N[a]=0}V(h,N,w,v);for(let a=0;a<R;a++)x[a]=h[a]*h[a]+N[a]*N[a];for(let a=0;a<F;a++){let c=0;const M=a*R;for(let d=0;d<R;d++)c+=x[d]*W[M+d];y[a*m+p]=Math.log(c+K)}}const l=u;u=o,u-T>m&&(T=u-m),D(),o-l>0&&performance.now()-s}function D(){const e=w>>1,r=u*G-e,s=Math.max(0,r),o=s-A;if(o>0&&o<E){const t=E-o;_.copyWithin(0,o,o+t),E=t,A=s}else o>=E&&(E=0,A=s)}function ee(e,r,s=!0){if(performance.now(),!y||u===0)return console.warn(`[MelWorker] getFeatures: no data (computedFrames=${u})`),null;const o=Math.max(T,e),l=Math.min(u,r)-o;if(l<=0)return console.warn(`[MelWorker] getFeatures: empty range (requested ${e}..${r}, available ${T}..${u})`),null;const i=new Float32Array(F*l);for(let f=0;f<F;f++){const p=f*m,a=f*l;for(let c=0;c<l;c++){const M=(o+c)%m;i[a+c]=y[p+M]}}const n=s?J(i,F,l):i;return performance.now(),{features:n,T:l,melBins:F}}function te(){if(!y||u===0)return null;const e=new Float32Array(F),r=(u-1+m)%m,s=u>=2?(u-2+m)%m:r;for(let o=0;o<F;o++){const t=o*m;e[o]=.5*(y[t+r]+y[t+s])}return e}function oe(){E=0,A=0,I=0,g=0,u=0,T=0}self.onmessage=e=>{const{type:r,payload:s,id:o}=e.data;try{switch(r){case"INIT":{X(s||{}),postMessage({type:"INIT_DONE",id:o});break}case"PUSH_AUDIO":{Y(s);break}case"GET_FEATURES":{const{startSample:t,endSample:l,normalize:i=!0}=s,n=B(t),f=B(l),p=ee(n,f,i);p?postMessage({type:"GET_FEATURES_DONE",payload:p,id:o},[p.features.buffer]):postMessage({type:"GET_FEATURES_DONE",payload:null,id:o});break}case"GET_STATUS":{postMessage({type:"GET_STATUS_DONE",payload:{totalSamples:g,computedFrames:u,bufferCapacityFrames:m,melBins:F},id:o});break}case"GET_LAST_MEL_FRAME":{const t=te();t?postMessage({type:"GET_LAST_MEL_FRAME_DONE",payload:{melFrame:t},id:o},[t.buffer]):postMessage({type:"GET_LAST_MEL_FRAME_DONE",payload:null,id:o});break}case"RESET":{oe(),postMessage({type:"RESET_DONE",id:o});break}default:console.warn("[MelWorker] Unknown message type:",r)}}catch(t){console.error("[MelWorker] Error:",t),postMessage({type:"ERROR",payload:t.message,id:o})}};
